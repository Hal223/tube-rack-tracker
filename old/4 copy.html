<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Sample Tracker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Wider container */
        .container {
            max-width: 90rem; /* Increased from 6xl */
        }
        /* Style for the grid cells */
        .grid-cell {
            border: 1px solid #d1d5db; /* gray-300 */
            min-width: 60px; /* Ensure minimum width */
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 4px; /* Slightly more padding */
            flex-shrink: 0; /* Prevent cells from shrinking */
        }
        .grid-cell.empty:hover {
            background-color: #e0f2fe; /* sky-100 */
        }
        .grid-cell.occupied {
            background-color: #bfdbfe; /* blue-200 */
            font-weight: 500;
            cursor: pointer; /* Still clickable to show details */
        }
        .grid-cell.occupied:hover {
            background-color: #93c5fd; /* blue-300 */
        }
        /* Grid container with horizontal scroll */
        #rack-grid-container {
             overflow-x: auto;
             padding-bottom: 8px; /* Space for scrollbar */
             background-color: #f9fafb; /* bg-gray-50 */
             border: 1px solid #e5e7eb; /* border-gray-200 */
             border-radius: 0.375rem; /* rounded-md */
        }
        #rack-grid {
            display: inline-grid; /* Use inline-grid for horizontal flow with scroll */
            grid-auto-flow: row; /* Flow rows first, then columns wrap inside scroll */
            /* grid-auto-rows: minmax(50px, auto); /* Let rows size automatically */
            /* grid-template-columns is set dynamically */
            gap: 4px; /* Reduced gap slightly */
            padding: 4px;
        }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-width: 500px; width: 90%; }
        .modal.active { display: flex; }

        /* Tab Styling */
        .tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        button i[data-lucide] { vertical-align: middle; }

        /* History Log Formatting */
        .history-entry { border-left: 3px solid; padding-left: 10px; margin-bottom: 8px; }
        .history-entry-rack { border-color: #60a5fa; /* blue-400 */ }
        .history-entry-sample { border-color: #34d399; /* emerald-400 */ }
        .history-timestamp { font-size: 0.75rem; color: #6b7280; /* gray-500 */ }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h1 class="text-3xl font-bold text-gray-800">Blood Sample Tracker</h1>
            <div class="flex space-x-2">
                 <button id="import-data-button" title="Import Data from JSON File" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="upload" class="mr-2 h-4 w-4"></i> Import
                </button>
                <button id="export-data-button" title="Export Data to JSON File" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="download" class="mr-2 h-4 w-4"></i> Export
                </button>
                <input type="file" id="import-file-input" accept=".json" class="hidden">
            </div>
        </div>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-main" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="main-content">
                    Racks & Samples
                </button>
                 <button id="tab-manage-racks" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="manage-racks-content">
                    Manage Racks
                </button>
                <button id="tab-history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="history-content">
                    Activity Log
                </button>
            </nav>
        </div>

        <div id="main-content" class="tab-pane active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-1 space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-700">Select Rack</h2>
                        <div id="rack-list-main" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                            <p class="text-gray-500 italic">No racks available.</p>
                        </div>
                    </div>
                    <div id="sample-details" class="bg-blue-50 p-4 rounded-md border border-blue-200 hidden">
                        <h3 class="text-lg font-semibold mb-2 text-blue-800">Sample Details</h3>
                        <p><strong>ID:</strong> <span id="detail-sample-id"></span></p>
                        <p><strong>Location:</strong> Rack <span id="detail-rack-name"></span>, R<span id="detail-row"></span>C<span id="detail-col"></span></p>
                        <p><strong>Comment:</strong> <span id="detail-comment" class="block whitespace-normal break-words"></span></p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Created:</strong> <span id="detail-created"></span></p>
                        <p class="text-xs text-gray-600"><strong>Modified:</strong> <span id="detail-modified"></span></p>
                        <div class="mt-3 space-x-2">
                            <button id="edit-sample-button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400">
                                <i data-lucide="edit" class="mr-1 h-4 w-4"></i> Edit Sample
                            </button>
                            <button id="delete-sample-button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i data-lucide="trash-2" class="mr-1 h-4 w-4"></i> Delete Sample
                            </button>
                             <button id="close-details-button" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Close
                            </button>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 space-y-6"> 
                    <div id="selected-rack-view" class="p-0">
                        <div class="flex justify-between items-center mb-3">
                             <h2 id="rack-title" class="text-xl font-semibold text-gray-700">Select a Rack</h2>
                             <button id="add-sample-button" class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="flask-conical" class="mr-2 h-5 w-5"></i> Add Sample to this Rack
                            </button>
                        </div>
                        <div id="rack-grid-container">
                            <div id="rack-grid" class="grid">
                                <p class="text-gray-500 italic p-4">Select a rack from the list to view its grid.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manage-racks-content" class="tab-pane hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Manage Racks</h2>
            <button id="add-rack-button" class="mb-6 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i data-lucide="plus-circle" class="mr-2 h-5 w-5"></i> Create New Rack
            </button>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dimensions</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                             <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manage-rack-table-body" class="bg-white divide-y divide-gray-200">
                        <tr id="no-racks-manage-row"><td colspan="5" class="px-6 py-4 text-sm text-gray-500 italic text-center">No racks created yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="history-content" class="tab-pane hidden">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Activity Log</h2>
             <div id="history-log-list" class="space-y-3 max-h-[600px] overflow-y-auto border rounded-md p-4 bg-gray-50">
                <p id="no-history-log-msg" class="text-gray-500 italic">No activity recorded yet.</p>
                </div>
        </div>

    </div> <div id="add-rack-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Create New Rack</h3> <form id="add-rack-form"> <div class="space-y-4"> <div> <label for="add-rack-name" class="block ...">Rack Name</label> <input type="text" name="add-rack-name" id="add-rack-name" required class="mt-1 block w-full ..."> <p id="add-rack-name-error" class="text-red-500 text-xs mt-1 hidden">Rack name already exists.</p> </div> <div> <label for="add-rack-rows" class="block ...">Rows</label> <input type="number" name="add-rack-rows" id="add-rack-rows" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="add-rack-cols" class="block ...">Columns</label> <input type="number" name="add-rack-cols" id="add-rack-cols" required min="1" class="mt-1 block w-full ..."> </div> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-add-rack" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Create Rack</button> </div> </form> </div> </div>
    <div id="edit-rack-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Edit Rack</h3> <form id="edit-rack-form"> <input type="hidden" id="edit-rack-id"> <div class="space-y-4"> <div> <label for="edit-rack-name" class="block ...">Rack Name</label> <input type="text" name="edit-rack-name" id="edit-rack-name" required class="mt-1 block w-full ..."> <p id="edit-rack-name-error" class="text-red-500 text-xs mt-1 hidden">Rack name already exists.</p> </div> <div> <label for="edit-rack-rows" class="block ...">Rows</label> <input type="number" name="edit-rack-rows" id="edit-rack-rows" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="edit-rack-cols" class="block ...">Columns</label> <input type="number" name="edit-rack-cols" id="edit-rack-cols" required min="1" class="mt-1 block w-full ..."> </div> <p id="edit-rack-dimension-error" class="text-red-500 text-xs mt-1 hidden">Cannot reduce dimensions...</p> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-edit-rack" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Save Changes</button> </div> </form> </div> </div>
    <div id="add-sample-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Add New Sample to <span id="modal-rack-name" class="font-bold"></span></h3> <form id="add-sample-form"> <input type="hidden" id="sample-rack-id"> <div class="space-y-4"> <div> <label for="sample-unique-id" class="block ...">Unique Sample ID</label> <input type="text" name="sample-unique-id" id="sample-unique-id" required class="mt-1 block w-full ..."> <p id="sample-id-error" class="text-red-500 text-xs mt-1 hidden">This Sample ID is already in use.</p> </div> <div> <label for="sample-row" class="block ...">Row</label> <input type="number" name="sample-row" id="sample-row" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="sample-col" class="block ...">Column</label> <input type="number" name="sample-col" id="sample-col" required min="1" class="mt-1 block w-full ..."> </div> <p id="location-error" class="text-red-500 text-xs mt-1 hidden">Invalid or occupied location.</p> <div> <label for="sample-comment" class="block ...">Comment (Optional)</label> <textarea name="sample-comment" id="sample-comment" rows="3" class="mt-1 block w-full ..."></textarea> </div> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-add-sample" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Add Sample</button> </div> </form> </div> </div>
    <div id="edit-sample-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Edit Sample</h3>
            <form id="edit-sample-form">
                <input type="hidden" id="edit-sample-id">
                <input type="hidden" id="edit-sample-original-rackid">
                <input type="hidden" id="edit-sample-original-row">
                <input type="hidden" id="edit-sample-original-col">
                <div class="space-y-4">
                    <div>
                        <label for="edit-sample-unique-id" class="block text-sm font-medium text-gray-700">Unique Sample ID</label>
                        <input type="text" name="edit-sample-unique-id" id="edit-sample-unique-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <p id="edit-sample-id-error" class="text-red-500 text-xs mt-1 hidden">This Sample ID is already in use.</p>
                    </div>
                    <div>
                        <label for="edit-sample-comment" class="block text-sm font-medium text-gray-700">Comment (Optional)</label>
                        <textarea name="edit-sample-comment" id="edit-sample-comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                    <p class="text-sm text-gray-600">Location: Rack <span id="edit-sample-location-rack"></span>, R<span id="edit-sample-location-row"></span>C<span id="edit-sample-location-col"></span> (Location cannot be changed here)</p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-sample" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Cancel</button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-yellow-500 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2">Save Sample Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 z-50 hidden rounded-md p-4 shadow-lg" role="alert"> <p id="message-text"></p> </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const rackListMainEl = document.getElementById('rack-list-main');
            const selectedRackViewEl = document.getElementById('selected-rack-view');
            const rackTitleEl = document.getElementById('rack-title');
            const rackGridContainerEl = document.getElementById('rack-grid-container'); // Container for scroll
            const rackGridEl = document.getElementById('rack-grid');
            const addSampleButton = document.getElementById('add-sample-button');

            // Sample Details Panel (Moved)
            const sampleDetailsEl = document.getElementById('sample-details');
            const detailSampleIdEl = document.getElementById('detail-sample-id');
            const detailRackNameEl = document.getElementById('detail-rack-name');
            const detailRowEl = document.getElementById('detail-row');
            const detailColEl = document.getElementById('detail-col');
            const detailCommentEl = document.getElementById('detail-comment');
            const detailCreatedEl = document.getElementById('detail-created');
            const detailModifiedEl = document.getElementById('detail-modified');
            const editSampleButton = document.getElementById('edit-sample-button'); // New button
            const deleteSampleButton = document.getElementById('delete-sample-button');
            const closeDetailsButton = document.getElementById('close-details-button');

            // Manage Racks Elements
            const addRackButton = document.getElementById('add-rack-button');
            const manageRackTableBodyEl = document.getElementById('manage-rack-table-body');
            const noRacksManageRowEl = document.getElementById('no-racks-manage-row');

            // History Log Elements
            const historyLogListEl = document.getElementById('history-log-list');
            const noHistoryLogMsgEl = document.getElementById('no-history-log-msg');

            // Tab Content Panes & Buttons
            const mainContentEl = document.getElementById('main-content');
            const manageRacksContentEl = document.getElementById('manage-racks-content');
            const historyContentEl = document.getElementById('history-content');
            const tabMainButton = document.getElementById('tab-main');
            const tabManageRacksButton = document.getElementById('tab-manage-racks');
            const tabHistoryButton = document.getElementById('tab-history');

            // Modals & Forms
            const addRackModal = document.getElementById('add-rack-modal');
            const addRackForm = document.getElementById('add-rack-form');
            const cancelAddRackButton = document.getElementById('cancel-add-rack');
            const addRackNameInput = document.getElementById('add-rack-name');
            const addRackNameError = document.getElementById('add-rack-name-error');

            const editRackModal = document.getElementById('edit-rack-modal');
            const editRackForm = document.getElementById('edit-rack-form');
            const cancelEditRackButton = document.getElementById('cancel-edit-rack');
            const editRackIdInput = document.getElementById('edit-rack-id');
            const editRackNameInput = document.getElementById('edit-rack-name');
            const editRackRowsInput = document.getElementById('edit-rack-rows');
            const editRackColsInput = document.getElementById('edit-rack-cols');
            const editRackNameError = document.getElementById('edit-rack-name-error');
            const editRackDimensionError = document.getElementById('edit-rack-dimension-error');

            const addSampleModal = document.getElementById('add-sample-modal');
            const addSampleForm = document.getElementById('add-sample-form');
            const cancelAddSampleButton = document.getElementById('cancel-add-sample');
            const modalRackNameEl = document.getElementById('modal-rack-name');
            const sampleRackIdInput = document.getElementById('sample-rack-id');
            const sampleUniqueIdInput = document.getElementById('sample-unique-id');
            const sampleRowInput = document.getElementById('sample-row');
            const sampleColInput = document.getElementById('sample-col');
            const sampleCommentInput = document.getElementById('sample-comment');
            const sampleIdErrorEl = document.getElementById('sample-id-error');
            const locationErrorEl = document.getElementById('location-error');

            const editSampleModal = document.getElementById('edit-sample-modal'); // New Modal
            const editSampleForm = document.getElementById('edit-sample-form');
            const cancelEditSampleButton = document.getElementById('cancel-edit-sample');
            const editSampleIdInput = document.getElementById('edit-sample-id');
            const editSampleUniqueIdInput = document.getElementById('edit-sample-unique-id');
            const editSampleCommentInput = document.getElementById('edit-sample-comment');
            const editSampleIdError = document.getElementById('edit-sample-id-error');
            // Spans to display location in edit modal
            const editSampleLocationRack = document.getElementById('edit-sample-location-rack');
            const editSampleLocationRow = document.getElementById('edit-sample-location-row');
            const editSampleLocationCol = document.getElementById('edit-sample-location-col');


            // General UI
            const messageBoxEl = document.getElementById('message-box');
            const messageTextEl = document.getElementById('message-text');
            const importDataButton = document.getElementById('import-data-button');
            const exportDataButton = document.getElementById('export-data-button');
            const importFileInput = document.getElementById('import-file-input');

            // --- State ---
            let racks = [];
            let samples = [];
            let historyLog = []; // New state for the comprehensive history log
            let selectedRackId = null;
            let selectedSampleId = null; // Holds the internal ID (e.g., id_123...) of the sample being viewed/edited

            // --- Utility Functions ---
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleString() : 'N/A';
            const escapeHtml = (unsafe) => {
                 return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
             }

            const showMessage = (text, type = 'success') => {
                messageTextEl.textContent = text;
                messageBoxEl.className = `fixed bottom-4 right-4 z-50 rounded-md p-4 shadow-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                messageBoxEl.classList.remove('hidden');
                setTimeout(() => { messageBoxEl.classList.add('hidden'); }, 3500);
            };

            // --- History Logging ---
            const logHistory = (type, details, relatedId = null) => {
                const entry = {
                    id: generateId(), // Give each log entry a unique ID
                    timestamp: new Date().toISOString(),
                    type: type, // e.g., 'rack_create', 'sample_update'
                    details: details, // Text description of the event
                    relatedId: relatedId // ID of the rack/sample involved, if applicable
                };
                historyLog.unshift(entry); // Add to the beginning of the log
                // Optional: Limit history log size if needed
                // if (historyLog.length > MAX_HISTORY_SIZE) { historyLog.pop(); }
                renderHistoryLog(); // Update the history view immediately
            };

            // --- Validation Functions (remain mostly the same) ---
            const isRackNameUnique = (name, rackIdToExclude = null) => !racks.some(r => r.name.toLowerCase() === name.trim().toLowerCase() && r.id !== rackIdToExclude);
            const checkDimensionChangeImpact = (rackId, newRows, newCols) => samples.filter(s => s.rackId === rackId && !s.isDeleted).some(s => s.row > newRows || s.col > newCols);
            const rackHasSamples = (rackId) => samples.some(s => s.rackId === rackId);
            const isSampleIdUnique = (uniqueId, sampleIdToExclude = null) => !samples.some(s => s.sampleUniqueId.toLowerCase() === uniqueId.trim().toLowerCase() && !s.isDeleted && s.id !== sampleIdToExclude);
            const isLocationValid = (rack, row, col) => rack && typeof rack.rows === 'number' && typeof rack.cols === 'number' && row >= 1 && row <= rack.rows && col >= 1 && col <= rack.cols;
            const isLocationOccupied = (rackId, row, col, sampleIdToExclude = null) => samples.some(s => s.rackId === rackId && s.row === row && s.col === col && !s.isDeleted && s.id !== sampleIdToExclude);

            // --- Rendering Functions ---
            const renderRackListMain = () => {
                rackListMainEl.innerHTML = '';
                if (racks.length === 0) { rackListMainEl.innerHTML = '<p class="text-gray-500 italic">No racks available...</p>'; return; }
                racks.forEach(rack => {
                    const rackDiv = document.createElement('div');
                    rackDiv.className = `p-3 border rounded-md cursor-pointer hover:bg-gray-200 ${rack.id === selectedRackId ? 'bg-blue-100 border-blue-300' : 'bg-white'}`;
                    rackDiv.dataset.rackId = rack.id;
                    rackDiv.innerHTML = `<p class="font-medium text-gray-800">${escapeHtml(rack.name)}</p><p class="text-sm text-gray-600">${rack.rows} x ${rack.cols}</p>`;
                    rackDiv.addEventListener('click', () => selectRack(rack.id));
                    rackListMainEl.appendChild(rackDiv);
                });
            };

            const renderManageRackList = () => {
                manageRackTableBodyEl.innerHTML = '';
                if (racks.length === 0) {
                    if (noRacksManageRowEl) { manageRackTableBodyEl.appendChild(noRacksManageRowEl); noRacksManageRowEl.classList.remove('hidden'); }
                    else { manageRackTableBodyEl.innerHTML = '<tr><td colspan="5" class="px-6 py-4 ...">No racks created yet.</td></tr>'; } // Added colspan="5"
                    return;
                }
                if (noRacksManageRowEl) noRacksManageRowEl.classList.add('hidden');
                racks.forEach(rack => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(rack.name)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rack.rows} x ${rack.cols}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(rack.createdAt)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(rack.updatedAt)}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button data-rack-id="${rack.id}" class="edit-rack-button text-indigo-600 hover:text-indigo-900" title="Edit Rack"><i data-lucide="edit" class="h-4 w-4 inline-block"></i> Edit</button>
                            <button data-rack-id="${rack.id}" data-rack-name="${escapeHtml(rack.name)}" class="delete-rack-button text-red-600 hover:text-red-900" title="Delete Rack"><i data-lucide="trash-2" class="h-4 w-4 inline-block"></i> Delete</button>
                        </td>`;
                    manageRackTableBodyEl.appendChild(row);
                });
                // Add event listeners
                manageRackTableBodyEl.querySelectorAll('.edit-rack-button').forEach(b => b.addEventListener('click', (e) => openEditRackModal(e.currentTarget.dataset.rackId)));
                manageRackTableBodyEl.querySelectorAll('.delete-rack-button').forEach(b => b.addEventListener('click', (e) => deleteRack(e.currentTarget.dataset.rackId, e.currentTarget.dataset.rackName)));
                lucide.createIcons();
            };

            const renderRackGrid = () => {
                rackGridEl.innerHTML = '';
                // sampleDetailsEl.classList.add('hidden'); // Don't hide details when grid re-renders if a sample is selected
                addSampleButton.classList.add('hidden');

                if (!selectedRackId) {
                    rackTitleEl.textContent = 'Select a Rack';
                    rackGridEl.innerHTML = '<p class="text-gray-500 italic p-4">Select a rack from the list to view its grid.</p>';
                    rackGridEl.style.gridTemplateColumns = ''; // Reset columns
                    return;
                }
                const rack = racks.find(r => r.id === selectedRackId);
                if (!rack) {
                    rackTitleEl.textContent = 'Rack Not Found';
                    rackGridEl.innerHTML = '<p class="text-red-500 italic p-4">Error: Could not find the selected rack.</p>';
                    rackGridEl.style.gridTemplateColumns = '';
                    selectedRackId = null;
                    return;
                }
                rackTitleEl.textContent = `Rack: ${escapeHtml(rack.name)} (${rack.rows}x${rack.cols})`;
                addSampleButton.classList.remove('hidden');
                // Set grid columns dynamically based on rack size for horizontal scroll
                rackGridEl.style.gridTemplateColumns = `repeat(${rack.cols}, minmax(60px, 1fr))`;

                const rackSamples = samples.filter(s => s.rackId === selectedRackId && !s.isDeleted);
                for (let r = 1; r <= rack.rows; r++) {
                    for (let c = 1; c <= rack.cols; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        const sampleInCell = rackSamples.find(s => s.row === r && s.col === c);
                        if (sampleInCell) {
                            cell.classList.add('occupied');
                            cell.textContent = escapeHtml(sampleInCell.sampleUniqueId);
                            cell.title = `Sample: ${escapeHtml(sampleInCell.sampleUniqueId)}\nComment: ${escapeHtml(sampleInCell.comment || 'None')}`;
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent triggering empty cell click
                                showSampleDetails(sampleInCell.id);
                            });
                        } else {
                            cell.classList.add('empty');
                            cell.title = `Empty: R${r}C${c}`;
                            cell.addEventListener('click', () => { openAddSampleModal(selectedRackId, r, c); });
                        }
                        rackGridEl.appendChild(cell);
                    }
                }
            };

            // Updated to render the new historyLog
            const renderHistoryLog = () => {
                 historyLogListEl.innerHTML = ''; // Clear existing list
                 if (historyLog.length === 0) {
                     noHistoryLogMsgEl.classList.remove('hidden');
                     return;
                 }
                 noHistoryLogMsgEl.classList.add('hidden');

                 historyLog.forEach(entry => {
                     const div = document.createElement('div');
                     const entryTypeClass = entry.type.startsWith('rack_') ? 'history-entry-rack' : 'history-entry-sample';
                     div.className = `history-entry ${entryTypeClass}`;
                     div.innerHTML = `
                         <p class="history-timestamp">${formatDate(entry.timestamp)}</p>
                         <p class="text-sm">${escapeHtml(entry.details)}</p>
                     `;

                     // Add restore button specifically for sample deletion entries
                     if (entry.type === 'sample_delete' && entry.relatedId) {
                         const restoreButton = document.createElement('button');
                         restoreButton.className = 'text-xs text-indigo-600 hover:text-indigo-900 mt-1';
                         restoreButton.textContent = 'Restore Sample';
                         restoreButton.onclick = () => restoreSample(entry.relatedId); // relatedId should be the sample's internal ID
                         div.appendChild(restoreButton);
                     }

                     historyLogListEl.appendChild(div);
                 });
             };

            // --- Refresh All Views ---
            const refreshAllViews = () => {
                 renderRackListMain();
                 renderManageRackList();
                 renderRackGrid();
                 renderHistoryLog(); // Use the new history log renderer
                 lucide.createIcons();
            }

            // --- Action Functions ---
            const addRack = (name, rows, cols) => {
                addRackNameError.classList.add('hidden');
                if (!name || !rows || !cols || rows < 1 || cols < 1) { showMessage('Invalid rack details.', 'error'); return; }
                if (!isRackNameUnique(name)) { addRackNameError.classList.remove('hidden'); return; }

                const now = new Date().toISOString();
                const newRack = { id: generateId(), name: name.trim(), rows: parseInt(rows, 10), cols: parseInt(cols, 10), createdAt: now, updatedAt: now };
                racks.push(newRack);
                logHistory('rack_create', `Rack "${newRack.name}" created (${newRack.rows}x${newRack.cols}).`, newRack.id);
                refreshAllViews();
                closeModal(addRackModal);
                showMessage(`Rack "${newRack.name}" created.`);
            };

            const updateRack = (rackId, newName, newRows, newCols) => {
                 editRackNameError.classList.add('hidden'); editRackDimensionError.classList.add('hidden');
                 const rackIndex = racks.findIndex(r => r.id === rackId);
                 if (rackIndex === -1) { showMessage("Rack not found.", "error"); return false; }

                 const originalRack = racks[rackIndex];
                 newName = newName.trim(); newRows = parseInt(newRows, 10); newCols = parseInt(newCols, 10);
                 let changes = []; // Track changes for log message

                 if (!isRackNameUnique(newName, rackId)) { editRackNameError.classList.remove('hidden'); return false; }
                 if (!newName || !newRows || !newCols || newRows < 1 || newCols < 1) { showMessage('Invalid details.', 'error'); return false; }
                 if ((newRows < originalRack.rows || newCols < originalRack.cols) && checkDimensionChangeImpact(rackId, newRows, newCols)) { editRackDimensionError.classList.remove('hidden'); return false; }

                 // Log specific changes
                 if (originalRack.name !== newName) changes.push(`name to "${newName}"`);
                 if (originalRack.rows !== newRows || originalRack.cols !== newCols) changes.push(`dimensions to ${newRows}x${newCols}`);

                 if (changes.length > 0) {
                     racks[rackIndex] = { ...originalRack, name: newName, rows: newRows, cols: newCols, updatedAt: new Date().toISOString() };
                     logHistory('rack_update', `Rack "${originalRack.name}" updated: ${changes.join(', ')}.`, rackId);
                     refreshAllViews();
                     closeModal(editRackModal);
                     showMessage(`Rack "${newName}" updated.`);
                     return true;
                 } else {
                     closeModal(editRackModal); // Close modal even if no changes
                     return false; // No changes made
                 }
            };

             const deleteRack = (rackId, rackName) => {
                if (rackHasSamples(rackId)) { showMessage(`Cannot delete rack "${rackName}": contains samples.`, 'error'); return; }
                if (confirm(`Delete empty rack "${rackName}"? This cannot be undone.`)) {
                    racks = racks.filter(r => r.id !== rackId);
                    logHistory('rack_delete', `Rack "${rackName}" deleted.`, rackId);
                    if (selectedRackId === rackId) { selectedRackId = null; } // Deselect if deleted
                    refreshAllViews();
                    showMessage(`Rack "${rackName}" deleted.`);
                }
            };

            const selectRack = (rackId) => {
                selectedRackId = rackId;
                selectedSampleId = null; // Clear selected sample
                sampleDetailsEl.classList.add('hidden'); // Hide details panel when rack changes
                renderRackListMain();
                renderRackGrid();
            };

             const addSample = (rackId, uniqueId, comment, row, col) => {
                 const rack = racks.find(r => r.id === rackId);
                 if (!rack) { showMessage('Rack not found.', 'error'); return false; }
                 row = parseInt(row, 10); col = parseInt(col, 10); uniqueId = uniqueId.trim();
                 sampleIdErrorEl.classList.add('hidden'); locationErrorEl.classList.add('hidden');
                 if (!isSampleIdUnique(uniqueId)) { sampleIdErrorEl.textContent = `Sample ID "${uniqueId}" is in use.`; sampleIdErrorEl.classList.remove('hidden'); return false; }
                 let locValid = true;
                 if (!isLocationValid(rack, row, col)) { locationErrorEl.textContent = `Location R${row}C${col} out of bounds.`; locValid = false; }
                 else if (isLocationOccupied(rackId, row, col)) { locationErrorEl.textContent = `Location R${row}C${col} occupied.`; locValid = false; }
                 if (!locValid) { locationErrorEl.classList.remove('hidden'); return false; }

                 const now = new Date().toISOString();
                 const newSample = { id: generateId(), sampleUniqueId: uniqueId, comment: comment.trim() || null, rackId: rackId, row: row, col: col, createdAt: now, updatedAt: now, isDeleted: false, deletedAt: null };
                 samples.push(newSample);
                 logHistory('sample_create', `Sample "${uniqueId}" added to ${rack.name} at R${row}C${col}.`, newSample.id);
                 renderRackGrid();
                 closeModal(addSampleModal);
                 showMessage(`Sample "${uniqueId}" added.`);
                 return true;
            };

             // NEW Function to update sample ID and comment
            const updateSample = (sampleId, newUniqueId, newComment) => {
                editSampleIdError.classList.add('hidden');
                const sampleIndex = samples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1) {
                    showMessage("Sample not found for editing.", "error");
                    return false;
                }
                const originalSample = samples[sampleIndex];
                newUniqueId = newUniqueId.trim();
                newComment = newComment.trim() || null; // Store empty comment as null

                // Validate Unique ID (excluding self)
                if (!isSampleIdUnique(newUniqueId, sampleId)) {
                    editSampleIdError.textContent = `Sample ID "${newUniqueId}" is already in use.`;
                    editSampleIdError.classList.remove('hidden');
                    return false;
                }

                let changes = [];
                if (originalSample.sampleUniqueId !== newUniqueId) changes.push(`ID changed to "${newUniqueId}"`);
                if (originalSample.comment !== newComment) changes.push(`comment updated`); // Keep log simple

                if (changes.length > 0) {
                    samples[sampleIndex] = {
                        ...originalSample,
                        sampleUniqueId: newUniqueId,
                        comment: newComment,
                        updatedAt: new Date().toISOString()
                    };
                    logHistory('sample_update', `Sample "${originalSample.sampleUniqueId}" updated: ${changes.join(', ')}.`, sampleId);
                    refreshAllViews(); // Update grid and details if visible
                    showSampleDetails(sampleId); // Re-render details panel with new info
                    closeModal(editSampleModal);
                    showMessage(`Sample "${newUniqueId}" updated.`);
                    return true;
                } else {
                    closeModal(editSampleModal); // No changes, just close
                    return false;
                }
            };


             const showSampleDetails = (sampleId) => {
                const sample = samples.find(s => s.id === sampleId && !s.isDeleted);
                if (!sample) { sampleDetailsEl.classList.add('hidden'); selectedSampleId = null; return; }
                const rack = racks.find(r => r.id === sample.rackId);
                selectedSampleId = sample.id; // Store internal ID

                detailSampleIdEl.textContent = escapeHtml(sample.sampleUniqueId);
                detailRackNameEl.textContent = escapeHtml(rack ? rack.name : 'Unknown');
                detailRowEl.textContent = sample.row;
                detailColEl.textContent = sample.col;
                detailCommentEl.textContent = escapeHtml(sample.comment || 'None');
                detailCreatedEl.textContent = formatDate(sample.createdAt);
                detailModifiedEl.textContent = formatDate(sample.updatedAt);
                sampleDetailsEl.classList.remove('hidden');
            };

             const deleteSample = (sampleId) => {
                const sampleIndex = samples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1 || samples[sampleIndex].isDeleted) return;
                const sample = samples[sampleIndex];
                const rack = racks.find(r => r.id === sample.rackId);

                sample.isDeleted = true;
                sample.deletedAt = new Date().toISOString();
                sample.updatedAt = sample.deletedAt;

                logHistory('sample_delete', `Sample "${sample.sampleUniqueId}" deleted from ${rack?.name || 'Unknown Rack'}.`, sampleId); // Log before clearing selection
                selectedSampleId = null;
                sampleDetailsEl.classList.add('hidden');
                renderRackGrid();
                // renderHistoryLog(); // Already called by logHistory
                showMessage(`Sample "${sample.sampleUniqueId}" deleted.`);
            };

            const restoreSample = (sampleId) => {
                const sampleIndex = samples.findIndex(s => s.id === sampleId);
                // Find original log entry if needed, but sample object has needed info
                if (sampleIndex === -1 || !samples[sampleIndex].isDeleted) { showMessage('Sample not found or not deleted.', 'error'); return; }

                const sample = samples[sampleIndex];
                const rack = racks.find(r => r.id === sample.rackId);

                if (!rack) { showMessage(`Cannot restore: Original rack (ID: ${sample.rackId}) not found.`, 'error'); return; } // Handle case where rack was deleted

                if (isLocationOccupied(sample.rackId, sample.row, sample.col)) { showMessage(`Cannot restore: Location R${sample.row}C${sample.col} in rack "${rack.name}" is now occupied.`, 'error'); return; }

                samples[sampleIndex].isDeleted = false;
                samples[sampleIndex].deletedAt = null;
                samples[sampleIndex].updatedAt = new Date().toISOString();

                logHistory('sample_restore', `Sample "${sample.sampleUniqueId}" restored to ${rack.name} at R${sample.row}C${sample.col}.`, sampleId);
                // refreshAllViews(); // logHistory calls renderHistoryLog, need to refresh grid too
                 if (sample.rackId === selectedRackId) { renderRackGrid(); } // Update grid if relevant
                 renderHistoryLog(); // Ensure button disappears from log
                showMessage(`Sample "${sample.sampleUniqueId}" restored.`);
            };


            // --- Import/Export Functions (Updated) ---
            const exportDataToFile = () => {
                if (racks.length === 0 && samples.length === 0 && historyLog.length === 0) { showMessage("No data to export.", "error"); return; }
                // Include historyLog in the export
                const dataToExport = { racks: racks, samples: samples, historyLog: historyLog };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const tempLink = document.createElement('a'); tempLink.href = url; tempLink.setAttribute('download', 'blood_sample_data_log.json'); tempLink.click(); // Changed filename slightly
                URL.revokeObjectURL(url); showMessage("Data exported successfully (with history).");
            };

            const importDataFromFile = (event) => {
                const file = event.target.files[0]; if (!file) { return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Validate presence of all expected arrays
                        if (Array.isArray(importedData.racks) && Array.isArray(importedData.samples) && Array.isArray(importedData.historyLog)) {
                            racks = importedData.racks;
                            samples = importedData.samples;
                            historyLog = importedData.historyLog; // Load history log

                            selectedRackId = null; selectedSampleId = null;
                            sampleDetailsEl.classList.add('hidden'); // Ensure details panel is hidden after import
                            refreshAllViews();
                            showMessage("Data imported successfully (with history).");
                        } else if (Array.isArray(importedData.racks) && Array.isArray(importedData.samples)) {
                             // Handle older format files gracefully (without history log)
                             racks = importedData.racks;
                             samples = importedData.samples;
                             historyLog = []; // Initialize empty history
                             logHistory('system_info', 'Imported data from older format (no history log included).');
                             selectedRackId = null; selectedSampleId = null;
                             sampleDetailsEl.classList.add('hidden');
                             refreshAllViews();
                             showMessage("Data imported successfully (older format, history reset).");
                        }

                        else { showMessage("Invalid file format: Missing 'racks', 'samples', or 'historyLog' array.", "error"); }
                    } catch (error) { showMessage(`Error parsing file: ${error.message}`, "error"); console.error("Import error:", error); }
                    finally { event.target.value = null; }
                };
                reader.onerror = (e) => { showMessage("Error reading file.", "error"); event.target.value = null; };
                reader.readAsText(file);
            };


            // --- Modal Handling ---
            const openModal = (modal) => { modal.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden')); modal.classList.add('active'); };
            const closeModal = (modal) => { modal.classList.remove('active'); const form = modal.querySelector('form'); if (form) form.reset(); modal.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden')); };

            const openAddSampleModal = (rackId, prefillRow = null, prefillCol = null) => {
                const rack = racks.find(r => r.id === rackId); if (!rack) return;
                modalRackNameEl.textContent = escapeHtml(rack.name); sampleRackIdInput.value = rackId;
                sampleRowInput.value = prefillRow || ''; sampleColInput.value = prefillCol || '';
                openModal(addSampleModal);
            };
            const openEditRackModal = (rackId) => {
                const rack = racks.find(r => r.id === rackId); if (!rack) { showMessage("Rack not found.", "error"); return; }
                editRackIdInput.value = rack.id; editRackNameInput.value = rack.name; editRackRowsInput.value = rack.rows; editRackColsInput.value = rack.cols;
                openModal(editRackModal);
            };
             // New function to open Edit Sample Modal
            const openEditSampleModal = (sampleId) => {
                const sample = samples.find(s => s.id === sampleId);
                if (!sample) { showMessage("Sample not found.", "error"); return; }
                const rack = racks.find(r => r.id === sample.rackId);

                editSampleIdInput.value = sample.id; // Store internal ID
                editSampleUniqueIdInput.value = sample.sampleUniqueId;
                editSampleCommentInput.value = sample.comment || '';
                // Display location info (read-only in this modal)
                editSampleLocationRack.textContent = escapeHtml(rack ? rack.name : 'Unknown');
                editSampleLocationRow.textContent = sample.row;
                editSampleLocationCol.textContent = sample.col;

                openModal(editSampleModal);
            };


            // --- Tab Navigation ---
             const switchTab = (targetId) => {
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                document.querySelector(`.tab-button[data-target='${targetId}']`).classList.add('active');
                // Refresh lists when switching to their tabs
                if (targetId === 'manage-racks-content') renderManageRackList();
                else if (targetId === 'history-content') renderHistoryLog();
                else if (targetId === 'main-content') { renderRackListMain(); renderRackGrid(); }
            };

            // --- Event Listeners ---
            // Add Rack
            addRackButton.addEventListener('click', () => openModal(addRackModal));
            cancelAddRackButton.addEventListener('click', () => closeModal(addRackModal));
            addRackForm.addEventListener('submit', (e) => { e.preventDefault(); addRack(addRackNameInput.value, document.getElementById('add-rack-rows').value, document.getElementById('add-rack-cols').value); });
            // Edit Rack
            cancelEditRackButton.addEventListener('click', () => closeModal(editRackModal));
            editRackForm.addEventListener('submit', (e) => { e.preventDefault(); updateRack(editRackIdInput.value, editRackNameInput.value, editRackRowsInput.value, editRackColsInput.value); });
            // Add Sample
            addSampleButton.addEventListener('click', () => { if(selectedRackId) openAddSampleModal(selectedRackId); });
            cancelAddSampleButton.addEventListener('click', () => closeModal(addSampleModal));
            addSampleForm.addEventListener('submit', (e) => { e.preventDefault(); addSample(sampleRackIdInput.value, sampleUniqueIdInput.value, sampleCommentInput.value, sampleRowInput.value, sampleColInput.value); });
            // Edit Sample
            editSampleButton.addEventListener('click', () => { if (selectedSampleId) openEditSampleModal(selectedSampleId); });
            cancelEditSampleButton.addEventListener('click', () => closeModal(editSampleModal));
            editSampleForm.addEventListener('submit', (e) => { e.preventDefault(); updateSample(editSampleIdInput.value, editSampleUniqueIdInput.value, editSampleCommentInput.value); });
            // Delete Sample
            deleteSampleButton.addEventListener('click', () => {
                if (selectedSampleId) {
                     const sample = samples.find(s => s.id === selectedSampleId);
                     if (confirm(`Delete sample ${sample?.sampleUniqueId || 'this sample'}?`)) { deleteSample(selectedSampleId); }
                }
            });
            closeDetailsButton.addEventListener('click', () => { sampleDetailsEl.classList.add('hidden'); selectedSampleId = null; });
            // Tabs
            tabMainButton.addEventListener('click', () => switchTab('main-content'));
            tabManageRacksButton.addEventListener('click', () => switchTab('manage-racks-content'));
            tabHistoryButton.addEventListener('click', () => switchTab('history-content'));
            // Import/Export
            exportDataButton.addEventListener('click', exportDataToFile);
            importDataButton.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importDataFromFile);
            // Modal Closing
            window.addEventListener('click', (event) => {
                if (event.target === addRackModal) closeModal(addRackModal);
                if (event.target === addSampleModal) closeModal(addSampleModal);
                if (event.target === editRackModal) closeModal(editRackModal);
                if (event.target === editSampleModal) closeModal(editSampleModal);
            });

            // --- Initial Load ---
            refreshAllViews();
            lucide.createIcons();
        });
    </script>

</body>
</html>
