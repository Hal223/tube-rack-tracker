<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Sample Tracker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Styles */
        body { font-family: 'Inter', sans-serif; }
        .container { max-width: 90rem; }

        /* --- Grid Cell Styles --- */
        .grid-cell-base { display: flex; align-items: center; justify-content: center; border: 1px solid #d1d5db; font-size: 0.75rem; flex-shrink: 0; background-color: white; }
        .grid-header-cell { min-width: 40px; min-height: 30px; font-weight: 600; background-color: #f3f4f6; color: #4b5563; position: sticky; z-index: 10; }
        .col-header-cell { top: 0; }
        .row-header-cell { left: 0; }
        .corner-placeholder { min-width: 40px; min-height: 30px; background-color: #e5e7eb; position: sticky; top: 0; left: 0; z-index: 20; border-color: #9ca3af; }

        .grid-cell { min-width: 65px; min-height: 50px; cursor: pointer; transition: background-color 0.2s ease-in-out; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 4px; }
        .grid-cell.empty:hover { background-color: #e0f2fe; }
        .grid-cell.occupied { background-color: #bfdbfe; font-weight: 500; }
        .grid-cell.occupied:hover { background-color: #93c5fd; }

        /* --- Alternating Shading --- */
        .row-even { background-color: #f9fafb !important; }
        .col-tenth { background-color: #f9fafb !important; }
        .row-even.occupied, .col-tenth.occupied { background-color: #bee3f8 !important; }
        .row-even.occupied:hover, .col-tenth.occupied:hover { background-color: #90cdf4 !important; }

        /* --- Grid Layout & Scrolling --- */
        #rack-grid-layout-container { display: grid; grid-template-columns: auto 1fr; grid-template-rows: auto auto 1fr; overflow: hidden; border: 1px solid #e5e7eb; border-radius: 0.375rem; position: relative; }
        #top-scrollbar-container { grid-column: 2 / 3; grid-row: 1 / 2; overflow-x: scroll; overflow-y: hidden; height: 18px; background: #f9fafb; /* Make scrollbar track visible */ scrollbar-width: thin; /* Firefox */ scrollbar-color: #cbd5e1 #f9fafb; /* Firefox: thumb track */ }
        /* Webkit scrollbar styling for top mimic */
        #top-scrollbar-container::-webkit-scrollbar { height: 8px; }
        #top-scrollbar-container::-webkit-scrollbar-track { background: #f9fafb; border-radius: 4px; }
        #top-scrollbar-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; border: 1px solid #f9fafb; }
        #top-scrollbar-content { height: 1px; }

        #column-headers-container { grid-column: 2 / 3; grid-row: 2 / 3; position: sticky; top: 0; z-index: 15; display: flex; background-color: #f3f4f6; border-bottom: 1px solid #d1d5db; }
        #row-headers-container { grid-column: 1 / 2; grid-row: 3 / 4; position: sticky; left: 0; z-index: 15; display: flex; flex-direction: column; background-color: #f3f4f6; border-right: 1px solid #d1d5db; }

        #grid-cells-scroller {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            overflow: auto; /* Keep scrolling enabled */
            background-color: #ffffff;
            /* --- Hide the native scrollbar --- */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        #grid-cells-scroller::-webkit-scrollbar {
            display: none;
        }

        #rack-grid { display: grid; gap: 0px; padding: 0; width: max-content; }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-width: 500px; width: 90%; }
        .modal.active { display: flex; }

        /* Tab Styling */
        .tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        button i[data-lucide] { vertical-align: middle; }

        /* History Log Formatting */
        .history-entry { border-left: 3px solid; padding-left: 10px; margin-bottom: 8px; }
        .history-entry-rack { border-color: #60a5fa; }
        .history-entry-sample { border-color: #34d399; }
        .history-entry-system { border-color: #9ca3af; }
        .history-timestamp { font-size: 0.75rem; color: #6b7280; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h1 class="text-3xl font-bold text-gray-800">Blood Sample Tracker</h1>
            <div class="flex space-x-2">
                 <button id="import-data-button" title="Import Data from JSON File" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="upload" class="mr-2 h-4 w-4"></i> Import
                </button>
                <button id="export-data-button" title="Export Data to JSON File" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="download" class="mr-2 h-4 w-4"></i> Export
                </button>
                <input type="file" id="import-file-input" accept=".json" class="hidden">
            </div>
        </div>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-main" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="main-content">
                    Racks & Samples
                </button>
                 <button id="tab-manage-racks" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="manage-racks-content">
                    Manage Racks
                </button>
                <button id="tab-history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="history-content">
                    Activity Log
                </button>
            </nav>
        </div>

        <div id="main-content" class="tab-pane active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-1 space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-700">Select Rack</h2>
                        <div id="rack-list-main" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                            <p class="text-gray-500 italic">No racks available.</p>
                        </div>
                    </div>
                    <div id="sample-details" class="bg-blue-50 p-4 rounded-md border border-blue-200 hidden">
                         <h3 class="text-lg font-semibold mb-2 text-blue-800">Sample Details</h3>
                        <p><strong>ID:</strong> <span id="detail-sample-id"></span></p>
                        {/* Updated Location Display */}
                        <p><strong>Location:</strong> Rack <span id="detail-rack-name"></span>, R<span id="detail-row"></span>C<span id="detail-col-letter"></span></p>
                        <p><strong>Comment:</strong> <span id="detail-comment" class="block whitespace-normal break-words"></span></p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Created:</strong> <span id="detail-created"></span></p>
                        <p class="text-xs text-gray-600"><strong>Modified:</strong> <span id="detail-modified"></span></p>
                        <div class="mt-3 space-x-2">
                            <button id="edit-sample-button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400">
                                <i data-lucide="edit" class="mr-1 h-4 w-4"></i> Edit
                            </button>
                            <button id="delete-sample-button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i data-lucide="trash-2" class="mr-1 h-4 w-4"></i> Delete
                            </button>
                             <button id="close-details-button" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Close
                            </button>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 space-y-6">
                    <div id="selected-rack-view" class="p-0">
                        <div class="flex justify-between items-center mb-3">
                             <h2 id="rack-title" class="text-xl font-semibold text-gray-700">Select a Rack</h2>
                             <button id="add-sample-button" class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="flask-conical" class="mr-2 h-5 w-5"></i> Add Sample
                            </button>
                        </div>
                         {/* Grid Layout Container */}
                        <div id="rack-grid-layout-container" class="hidden">
                             <div id="corner-placeholder" class="corner-placeholder grid-cell-base"></div>
                             <div id="top-scrollbar-container"> <div id="top-scrollbar-content"></div> </div>
                             <div id="column-headers-container"></div>
                             <div id="row-headers-container"></div>
                             <div id="grid-cells-scroller"> <div id="rack-grid"></div> </div>
                        </div>
                        <div id="select-rack-prompt" class="italic text-gray-500 p-4 bg-gray-50 rounded-md border">
                            Select a rack from the list to view its grid.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manage-racks-content" class="tab-pane hidden">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Manage Racks</h2>
            <button id="add-rack-button" class="mb-6 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i data-lucide="plus-circle" class="mr-2 h-5 w-5"></i> Create New Rack
            </button>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                     <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dimensions</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                             <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manage-rack-table-body" class="bg-white divide-y divide-gray-200">
                        <tr id="no-racks-manage-row"><td colspan="5" class="px-6 py-4 text-sm text-gray-500 italic text-center">No racks created yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="history-content" class="tab-pane hidden">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Activity Log</h2>
             <div id="history-log-list" class="space-y-3 max-h-[600px] overflow-y-auto border rounded-md p-4 bg-gray-50">
                <p id="no-history-log-msg" class="text-gray-500 italic">No activity recorded yet.</p>
             </div>
        </div>

    </div> <div id="add-rack-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Create New Rack</h3> <form id="add-rack-form"> <div class="space-y-4"> <div> <label for="add-rack-name" class="block ...">Rack Name</label> <input type="text" name="add-rack-name" id="add-rack-name" required class="mt-1 block w-full ..."> <p id="add-rack-name-error" class="text-red-500 text-xs mt-1 hidden">Rack name already exists.</p> </div> <div> <label for="add-rack-rows" class="block ...">Rows</label> <input type="number" name="add-rack-rows" id="add-rack-rows" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="add-rack-cols" class="block ...">Columns</label> <input type="number" name="add-rack-cols" id="add-rack-cols" required min="1" class="mt-1 block w-full ..."> </div> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-add-rack" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Create Rack</button> </div> </form> </div> </div>
    <div id="edit-rack-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Edit Rack</h3> <form id="edit-rack-form"> <input type="hidden" id="edit-rack-id"> <div class="space-y-4"> <div> <label for="edit-rack-name" class="block ...">Rack Name</label> <input type="text" name="edit-rack-name" id="edit-rack-name" required class="mt-1 block w-full ..."> <p id="edit-rack-name-error" class="text-red-500 text-xs mt-1 hidden">Rack name already exists.</p> </div> <div> <label for="edit-rack-rows" class="block ...">Rows</label> <input type="number" name="edit-rack-rows" id="edit-rack-rows" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="edit-rack-cols" class="block ...">Columns</label> <input type="number" name="edit-rack-cols" id="edit-rack-cols" required min="1" class="mt-1 block w-full ..."> </div> <p id="edit-rack-dimension-error" class="text-red-500 text-xs mt-1 hidden">Cannot reduce dimensions...</p> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-edit-rack" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Save Changes</button> </div> </form> </div> </div>
    <div id="add-sample-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Add New Sample to <span id="modal-rack-name" class="font-bold"></span></h3> <form id="add-sample-form"> <input type="hidden" id="sample-rack-id"> <div class="space-y-4"> <div> <label for="sample-unique-id" class="block ...">Unique Sample ID</label> <input type="text" name="sample-unique-id" id="sample-unique-id" required class="mt-1 block w-full ..."> <p id="sample-id-error" class="text-red-500 text-xs mt-1 hidden">This Sample ID is already in use.</p> </div> <div> <label for="sample-row" class="block ...">Row</label> <input type="number" name="sample-row" id="sample-row" required min="1" class="mt-1 block w-full ..."> </div> <div> <label for="sample-col" class="block ...">Column</label> <input type="number" name="sample-col" id="sample-col" required min="1" class="mt-1 block w-full ..."> <span class="text-xs text-gray-500 ml-2"> (Letter: <span id="add-sample-col-letter-preview"></span>)</span> </div> <p id="location-error" class="text-red-500 text-xs mt-1 hidden">Invalid or occupied location.</p> <div> <label for="sample-comment" class="block ...">Comment (Optional)</label> <textarea name="sample-comment" id="sample-comment" rows="3" class="mt-1 block w-full ..."></textarea> </div> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-add-sample" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ...">Add Sample</button> </div> </form> </div> </div>
    <div id="edit-sample-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-medium ... mb-4">Edit Sample</h3> <form id="edit-sample-form"> <input type="hidden" id="edit-sample-id"> <div class="space-y-4"> <div> <label for="edit-sample-unique-id" class="block ...">Unique Sample ID</label> <input type="text" name="edit-sample-unique-id" id="edit-sample-unique-id" required class="mt-1 block w-full ..."> <p id="edit-sample-id-error" class="text-red-500 text-xs mt-1 hidden">This Sample ID is already in use.</p> </div> <div> <label for="edit-sample-comment" class="block ...">Comment (Optional)</label> <textarea name="edit-sample-comment" id="edit-sample-comment" rows="3" class="mt-1 block w-full ..."></textarea> </div> <p class="text-sm text-gray-600">Location: Rack <span id="edit-sample-location-rack"></span>, R<span id="edit-sample-location-row"></span>C<span id="edit-sample-location-col-letter"></span> (Location cannot be changed here)</p> </div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-edit-sample" class="inline-flex ...">Cancel</button> <button type="submit" class="inline-flex ... bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400">Save Sample Changes</button> </div> </form> </div> </div>
    <div id="message-box" class="fixed bottom-4 right-4 z-50 hidden rounded-md p-4 shadow-lg" role="alert"> <p id="message-text"></p> </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            // ... (Keep all previous DOM element references) ...
            const rackListMainEl = document.getElementById('rack-list-main');
            const selectedRackViewEl = document.getElementById('selected-rack-view');
            const rackTitleEl = document.getElementById('rack-title');
            const rackGridLayoutContainerEl = document.getElementById('rack-grid-layout-container');
            const selectRackPromptEl = document.getElementById('select-rack-prompt');
            const cornerPlaceholderEl = document.getElementById('corner-placeholder');
            const topScrollbarContainerEl = document.getElementById('top-scrollbar-container');
            const topScrollbarContentEl = document.getElementById('top-scrollbar-content');
            const columnHeadersContainerEl = document.getElementById('column-headers-container');
            const rowHeadersContainerEl = document.getElementById('row-headers-container');
            const gridCellsScrollerEl = document.getElementById('grid-cells-scroller');
            const rackGridEl = document.getElementById('rack-grid');
            const addSampleButton = document.getElementById('add-sample-button');
            const sampleDetailsEl = document.getElementById('sample-details');
            const detailSampleIdEl = document.getElementById('detail-sample-id');
            const detailRackNameEl = document.getElementById('detail-rack-name');
            const detailRowEl = document.getElementById('detail-row');
            const detailColLetterEl = document.getElementById('detail-col-letter'); // Updated ID
            const detailCommentEl = document.getElementById('detail-comment');
            const detailCreatedEl = document.getElementById('detail-created');
            const detailModifiedEl = document.getElementById('detail-modified');
            const editSampleButton = document.getElementById('edit-sample-button');
            const deleteSampleButton = document.getElementById('delete-sample-button');
            const closeDetailsButton = document.getElementById('close-details-button');
            const addRackButton = document.getElementById('add-rack-button');
            const manageRackTableBodyEl = document.getElementById('manage-rack-table-body');
            const noRacksManageRowEl = document.getElementById('no-racks-manage-row');
            const historyLogListEl = document.getElementById('history-log-list');
            const noHistoryLogMsgEl = document.getElementById('no-history-log-msg');
            const mainContentEl = document.getElementById('main-content');
            const manageRacksContentEl = document.getElementById('manage-racks-content');
            const historyContentEl = document.getElementById('history-content');
            const tabMainButton = document.getElementById('tab-main');
            const tabManageRacksButton = document.getElementById('tab-manage-racks');
            const tabHistoryButton = document.getElementById('tab-history');
            const addRackModal = document.getElementById('add-rack-modal');
            const addRackForm = document.getElementById('add-rack-form');
            const cancelAddRackButton = document.getElementById('cancel-add-rack');
            const addRackNameInput = document.getElementById('add-rack-name');
            const addRackNameError = document.getElementById('add-rack-name-error');
            const editRackModal = document.getElementById('edit-rack-modal');
            const editRackForm = document.getElementById('edit-rack-form');
            const cancelEditRackButton = document.getElementById('cancel-edit-rack');
            const editRackIdInput = document.getElementById('edit-rack-id');
            const editRackNameInput = document.getElementById('edit-rack-name');
            const editRackRowsInput = document.getElementById('edit-rack-rows');
            const editRackColsInput = document.getElementById('edit-rack-cols');
            const editRackNameError = document.getElementById('edit-rack-name-error');
            const editRackDimensionError = document.getElementById('edit-rack-dimension-error');
            const addSampleModal = document.getElementById('add-sample-modal');
            const addSampleForm = document.getElementById('add-sample-form');
            const cancelAddSampleButton = document.getElementById('cancel-add-sample');
            const modalRackNameEl = document.getElementById('modal-rack-name');
            const sampleRackIdInput = document.getElementById('sample-rack-id');
            const sampleUniqueIdInput = document.getElementById('sample-unique-id');
            const sampleRowInput = document.getElementById('sample-row');
            const sampleColInput = document.getElementById('sample-col');
            const sampleColLetterPreview = document.getElementById('add-sample-col-letter-preview'); // Span for letter preview
            const sampleCommentInput = document.getElementById('sample-comment');
            const sampleIdErrorEl = document.getElementById('sample-id-error');
            const locationErrorEl = document.getElementById('location-error');
            const editSampleModal = document.getElementById('edit-sample-modal');
            const editSampleForm = document.getElementById('edit-sample-form');
            const cancelEditSampleButton = document.getElementById('cancel-edit-sample');
            const editSampleIdInput = document.getElementById('edit-sample-id');
            const editSampleUniqueIdInput = document.getElementById('edit-sample-unique-id');
            const editSampleCommentInput = document.getElementById('edit-sample-comment');
            const editSampleIdError = document.getElementById('edit-sample-id-error');
            const editSampleLocationRack = document.getElementById('edit-sample-location-rack');
            const editSampleLocationRow = document.getElementById('edit-sample-location-row');
            const editSampleLocationColLetter = document.getElementById('edit-sample-location-col-letter'); // Updated ID
            const messageBoxEl = document.getElementById('message-box');
            const messageTextEl = document.getElementById('message-text');
            const importDataButton = document.getElementById('import-data-button');
            const exportDataButton = document.getElementById('export-data-button');
            const importFileInput = document.getElementById('import-file-input');


            // --- State ---
            let racks = [];
            let samples = [];
            let historyLog = [];
            let selectedRackId = null;
            let selectedSampleId = null;

            // --- Constants ---
            const CELL_WIDTH = 65;
            const CELL_HEIGHT = 50;
            const HEADER_WIDTH = 40;
            const HEADER_HEIGHT = 30;

            // --- Utility Functions ---
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleString() : 'N/A';
            const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            const showMessage = (text, type = 'success') => { /* ... */ messageTextEl.textContent = text; messageBoxEl.className = `fixed bottom-4 right-4 z-50 rounded-md p-4 shadow-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`; messageBoxEl.classList.remove('hidden'); setTimeout(() => { messageBoxEl.classList.add('hidden'); }, 3500); };

            // --- NEW: Convert column number to letter(s) ---
            const getColumnLetter = (colNumber) => {
                let columnName = '';
                let base = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let baseLen = base.length;
                let num = colNumber; // Use 1-based index

                while (num > 0) {
                    let remainder = (num - 1) % baseLen;
                    columnName = base[remainder] + columnName;
                    num = Math.floor((num - 1) / baseLen);
                }
                return columnName || '??'; // Handle potential edge cases or 0 input
            };

            // --- Validation Functions ---
            const isRackNameUnique = (name, rackIdToExclude = null) => !racks.some(r => r.name.toLowerCase() === name.trim().toLowerCase() && r.id !== rackIdToExclude);
            const checkDimensionChangeImpact = (rackId, newRows, newCols) => samples.filter(s => s.rackId === rackId && !s.isDeleted).some(s => s.row > newRows || s.col > newCols);
            const rackHasSamples = (rackId) => samples.some(s => s.rackId === rackId);
            const isSampleIdUnique = (uniqueId, sampleIdToExclude = null) => !samples.some(s => s.sampleUniqueId.toLowerCase() === uniqueId.trim().toLowerCase() && !s.isDeleted && s.id !== sampleIdToExclude);
            const isLocationValid = (rack, row, col) => rack && typeof rack.rows === 'number' && typeof rack.cols === 'number' && row >= 1 && row <= rack.rows && col >= 1 && col <= rack.cols;
            const isLocationOccupied = (rackId, row, col, sampleIdToExclude = null) => samples.some(s => s.rackId === rackId && s.row === row && s.col === col && !s.isDeleted && s.id !== sampleIdToExclude);

            // --- History Logging ---
            const logHistory = (type, details, relatedId = null) => { const entry = { id: generateId(), timestamp: new Date().toISOString(), type: type, details: details, relatedId: relatedId }; historyLog.unshift(entry); renderHistoryLog(); };

            // --- Scroll Synchronization ---
            let isSyncingScroll = false;
            function syncScroll(sourceElement, targetElements) { if (isSyncingScroll) return; isSyncingScroll = true; const scrollLeft = sourceElement.scrollLeft; const scrollTop = sourceElement.scrollTop; targetElements.forEach(target => { if (target.scrollLeft !== scrollLeft) { target.scrollLeft = scrollLeft; } if ((sourceElement === gridCellsScrollerEl || sourceElement === rowHeadersContainerEl) && (target === gridCellsScrollerEl || target === rowHeadersContainerEl) && target.scrollTop !== scrollTop) { target.scrollTop = scrollTop; } }); requestAnimationFrame(() => { isSyncingScroll = false; }); }
            function attachScrollListeners() { topScrollbarContainerEl.removeEventListener('scroll', handleTopScroll); gridCellsScrollerEl.removeEventListener('scroll', handleMainScroll); topScrollbarContainerEl.addEventListener('scroll', handleTopScroll); gridCellsScrollerEl.addEventListener('scroll', handleMainScroll); }
            function handleTopScroll() { syncScroll(topScrollbarContainerEl, [gridCellsScrollerEl, columnHeadersContainerEl]); }
            function handleMainScroll() { syncScroll(gridCellsScrollerEl, [topScrollbarContainerEl, columnHeadersContainerEl, rowHeadersContainerEl]); }

            // --- Rendering Functions ---
            const renderRackListMain = () => { /* ... unchanged ... */ rackListMainEl.innerHTML = ''; if (racks.length === 0) { rackListMainEl.innerHTML = '<p class="text-gray-500 italic">No racks available...</p>'; return; } racks.forEach(rack => { const d = document.createElement('div'); d.className = `p-3 border rounded-md cursor-pointer hover:bg-gray-200 ${rack.id === selectedRackId ? 'bg-blue-100 border-blue-300' : 'bg-white'}`; d.dataset.rackId = rack.id; d.innerHTML = `<p class="font-medium text-gray-800">${escapeHtml(rack.name)}</p><p class="text-sm text-gray-600">${rack.rows} x ${rack.cols}</p>`; d.addEventListener('click', () => selectRack(rack.id)); rackListMainEl.appendChild(d); }); };
            const renderManageRackList = () => { /* ... unchanged ... */ manageRackTableBodyEl.innerHTML = ''; if (racks.length === 0) { if (noRacksManageRowEl) { manageRackTableBodyEl.appendChild(noRacksManageRowEl); noRacksManageRowEl.classList.remove('hidden'); } else { manageRackTableBodyEl.innerHTML = '<tr><td colspan="5" class="px-6 py-4 ...">No racks created yet.</td></tr>'; } return; } if (noRacksManageRowEl) noRacksManageRowEl.classList.add('hidden'); racks.forEach(rack => { const r = document.createElement('tr'); r.innerHTML = `<td class="px-6 py-4 ...">${escapeHtml(rack.name)}</td><td class="px-6 py-4 ...">${rack.rows} x ${rack.cols}</td><td class="px-6 py-4 ...">${formatDate(rack.createdAt)}</td><td class="px-6 py-4 ...">${formatDate(rack.updatedAt)}</td><td class="px-6 py-4 ... space-x-2"><button data-rack-id="${rack.id}" class="edit-rack-button ..."><i data-lucide="edit" class="h-4 w-4 ..."></i> Edit</button><button data-rack-id="${rack.id}" data-rack-name="${escapeHtml(rack.name)}" class="delete-rack-button ..."><i data-lucide="trash-2" class="h-4 w-4 ..."></i> Delete</button></td>`; manageRackTableBodyEl.appendChild(r); }); manageRackTableBodyEl.querySelectorAll('.edit-rack-button').forEach(b => b.addEventListener('click', (e) => openEditRackModal(e.currentTarget.dataset.rackId))); manageRackTableBodyEl.querySelectorAll('.delete-rack-button').forEach(b => b.addEventListener('click', (e) => deleteRack(e.currentTarget.dataset.rackId, e.currentTarget.dataset.rackName))); lucide.createIcons(); };

            // --- Updated renderRackGrid ---
            const renderRackGrid = () => {
                rackGridEl.innerHTML = ''; columnHeadersContainerEl.innerHTML = ''; rowHeadersContainerEl.innerHTML = ''; addSampleButton.classList.add('hidden');

                if (!selectedRackId) {
                    rackTitleEl.textContent = 'Select a Rack'; rackGridLayoutContainerEl.classList.add('hidden'); selectRackPromptEl.classList.remove('hidden');
                    return;
                }
                const rack = racks.find(r => r.id === selectedRackId);
                if (!rack) {
                    rackTitleEl.textContent = 'Rack Not Found'; rackGridLayoutContainerEl.classList.add('hidden'); selectRackPromptEl.classList.remove('hidden'); selectRackPromptEl.textContent = 'Error: Could not find the selected rack.'; selectRackPromptEl.classList.add('text-red-500'); selectedRackId = null;
                    return;
                }

                rackTitleEl.textContent = `Rack: ${escapeHtml(rack.name)} (${rack.rows}x${rack.cols})`; rackGridLayoutContainerEl.classList.remove('hidden'); selectRackPromptEl.classList.add('hidden'); selectRackPromptEl.classList.remove('text-red-500'); selectRackPromptEl.textContent = 'Select a rack from the list to view its grid.'; addSampleButton.classList.remove('hidden');

                // Column Headers (Using Letters)
                for (let c = 1; c <= rack.cols; c++) {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'grid-header-cell col-header-cell grid-cell-base';
                    headerCell.style.minWidth = `${CELL_WIDTH}px`;
                    headerCell.textContent = getColumnLetter(c); // Use letter function
                    if (c % 10 === 0) headerCell.classList.add('col-tenth');
                    columnHeadersContainerEl.appendChild(headerCell);
                }
                // Row Headers
                for (let r = 1; r <= rack.rows; r++) {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'grid-header-cell row-header-cell grid-cell-base';
                    headerCell.style.minHeight = `${CELL_HEIGHT}px`;
                    headerCell.textContent = r;
                    if (r % 2 === 0) headerCell.classList.add('row-even');
                    rowHeadersContainerEl.appendChild(headerCell);
                }

                // Sample Grid Cells
                rackGridEl.style.gridTemplateColumns = `repeat(${rack.cols}, ${CELL_WIDTH}px)`;
                rackGridEl.style.gridTemplateRows = `repeat(${rack.rows}, ${CELL_HEIGHT}px)`;
                const rackSamples = samples.filter(s => s.rackId === selectedRackId && !s.isDeleted);
                for (let r = 1; r <= rack.rows; r++) {
                    for (let c = 1; c <= rack.cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell grid-cell-base';
                        cell.dataset.row = r; cell.dataset.col = c; // Keep internal col number
                        if (r % 2 === 0) cell.classList.add('row-even');
                        if (c % 10 === 0) cell.classList.add('col-tenth');
                        const sampleInCell = rackSamples.find(s => s.row === r && s.col === c);
                        if (sampleInCell) {
                            cell.classList.add('occupied'); cell.textContent = escapeHtml(sampleInCell.sampleUniqueId);
                            cell.title = `Sample: ${escapeHtml(sampleInCell.sampleUniqueId)}\nLocation: R${r}C${getColumnLetter(c)}\nComment: ${escapeHtml(sampleInCell.comment || 'None')}`; // Use letter in title
                            cell.addEventListener('click', (e) => { e.stopPropagation(); showSampleDetails(sampleInCell.id); });
                        } else {
                            cell.classList.add('empty'); cell.title = `Empty: R${r}C${getColumnLetter(c)}`; // Use letter in title
                            cell.addEventListener('click', () => { openAddSampleModal(selectedRackId, r, c); });
                        }
                        rackGridEl.appendChild(cell);
                    }
                }

                // Setup Top Scrollbar & Syncing
                requestAnimationFrame(() => {
                    const gridContentWidth = rackGridEl.scrollWidth;
                    topScrollbarContentEl.style.width = `${gridContentWidth}px`;
                    gridCellsScrollerEl.scrollTop = 0; gridCellsScrollerEl.scrollLeft = 0; topScrollbarContainerEl.scrollLeft = 0; rowHeadersContainerEl.scrollTop = 0; columnHeadersContainerEl.scrollLeft = 0;
                    attachScrollListeners();
                });
            };

            const renderHistoryLog = () => { /* ... unchanged ... */ historyLogListEl.innerHTML = ''; if (historyLog.length === 0) { noHistoryLogMsgEl.classList.remove('hidden'); return; } noHistoryLogMsgEl.classList.add('hidden'); historyLog.forEach(entry => { const d = document.createElement('div'); const cls = entry.type.startsWith('rack_') ? 'history-entry-rack' : (entry.type.startsWith('sample_') ? 'history-entry-sample' : 'history-entry-system'); d.className = `history-entry ${cls}`; d.innerHTML = `<p class="history-timestamp">${formatDate(entry.timestamp)}</p><p class="text-sm">${escapeHtml(entry.details)}</p>`; if (entry.type === 'sample_delete' && entry.relatedId) { const btn = document.createElement('button'); btn.className = 'text-xs text-indigo-600 hover:text-indigo-900 mt-1'; btn.textContent = 'Restore Sample'; btn.onclick = () => restoreSample(entry.relatedId); d.appendChild(btn); } historyLogListEl.appendChild(d); }); };

            // --- Refresh All Views ---
            const refreshAllViews = () => { renderRackListMain(); renderManageRackList(); renderRackGrid(); renderHistoryLog(); lucide.createIcons(); }

            // --- Action Functions (Update logging/display for column letters) ---
            const addRack = (name, rows, cols) => { /* ... validation ... */ const now = new Date().toISOString(); const newRack = { id: generateId(), name: name.trim(), rows: parseInt(rows, 10), cols: parseInt(cols, 10), createdAt: now, updatedAt: now }; racks.push(newRack); logHistory('rack_create', `Rack "${newRack.name}" created (${newRack.rows}x${newRack.cols}).`, newRack.id); refreshAllViews(); closeModal(addRackModal); showMessage(`Rack "${newRack.name}" created.`); };
            const updateRack = (rackId, newName, newRows, newCols) => { /* ... validation ... */ const rackIndex = racks.findIndex(r => r.id === rackId); if (rackIndex === -1) { /*...*/ return false; } const originalRack = racks[rackIndex]; let changes = []; if (originalRack.name !== newName.trim()) changes.push(`name to "${newName.trim()}"`); if (originalRack.rows !== parseInt(newRows,10) || originalRack.cols !== parseInt(newCols,10)) changes.push(`dimensions to ${newRows}x${newCols}`); if (changes.length > 0) { racks[rackIndex] = { ...originalRack, name: newName.trim(), rows: parseInt(newRows,10), cols: parseInt(newCols,10), updatedAt: new Date().toISOString() }; logHistory('rack_update', `Rack "${originalRack.name}" updated: ${changes.join(', ')}.`, rackId); refreshAllViews(); closeModal(editRackModal); showMessage(`Rack "${newName.trim()}" updated.`); return true; } else { closeModal(editRackModal); return false; } };
            const deleteRack = (rackId, rackName) => { if (rackHasSamples(rackId)) { showMessage(`Cannot delete rack "${rackName}": contains samples.`, 'error'); return; } if (confirm(`Delete empty rack "${rackName}"? This cannot be undone.`)) { const originalName = racks.find(r => r.id === rackId)?.name || rackName; racks = racks.filter(r => r.id !== rackId); logHistory('rack_delete', `Rack "${originalName}" deleted.`, rackId); if (selectedRackId === rackId) { selectedRackId = null; } refreshAllViews(); showMessage(`Rack "${originalName}" deleted.`); } };
            const selectRack = (rackId) => { selectedRackId = rackId; selectedSampleId = null; sampleDetailsEl.classList.add('hidden'); renderRackListMain(); renderRackGrid(); };
            const addSample = (rackId, uniqueId, comment, row, col) => { /* ... validation ... */ const rack = racks.find(r => r.id === rackId); const now = new Date().toISOString(); const newSample = { id: generateId(), sampleUniqueId: uniqueId.trim(), comment: comment.trim() || null, rackId: rackId, row: parseInt(row,10), col: parseInt(col,10), createdAt: now, updatedAt: now, isDeleted: false, deletedAt: null }; samples.push(newSample); logHistory('sample_create', `Sample "${newSample.sampleUniqueId}" added to ${rack.name} at R${newSample.row}C${getColumnLetter(newSample.col)}.`, newSample.id); renderRackGrid(); closeModal(addSampleModal); showMessage(`Sample "${newSample.sampleUniqueId}" added.`); return true; }; // Use letter in log
            const updateSample = (sampleId, newUniqueId, newComment) => { /* ... validation ... */ const sampleIndex = samples.findIndex(s => s.id === sampleId); if (sampleIndex === -1) { /*...*/ return false; } const originalSample = samples[sampleIndex]; let changes = []; if (originalSample.sampleUniqueId !== newUniqueId.trim()) changes.push(`ID to "${newUniqueId.trim()}"`); if (originalSample.comment !== (newComment.trim() || null)) changes.push(`comment updated`); if (changes.length > 0) { samples[sampleIndex] = { ...originalSample, sampleUniqueId: newUniqueId.trim(), comment: newComment.trim() || null, updatedAt: new Date().toISOString() }; logHistory('sample_update', `Sample "${originalSample.sampleUniqueId}" updated: ${changes.join(', ')}.`, sampleId); refreshAllViews(); showSampleDetails(sampleId); closeModal(editSampleModal); showMessage(`Sample "${newUniqueId.trim()}" updated.`); return true; } else { closeModal(editSampleModal); return false; } };
            const showSampleDetails = (sampleId) => { const sample = samples.find(s => s.id === sampleId && !s.isDeleted); if (!sample) { sampleDetailsEl.classList.add('hidden'); selectedSampleId = null; return; } const rack = racks.find(r => r.id === sample.rackId); selectedSampleId = sample.id; detailSampleIdEl.textContent = escapeHtml(sample.sampleUniqueId); detailRackNameEl.textContent = escapeHtml(rack ? rack.name : 'Unknown'); detailRowEl.textContent = sample.row; detailColLetterEl.textContent = getColumnLetter(sample.col); detailCommentEl.textContent = escapeHtml(sample.comment || 'None'); detailCreatedEl.textContent = formatDate(sample.createdAt); detailModifiedEl.textContent = formatDate(sample.updatedAt); sampleDetailsEl.classList.remove('hidden'); }; // Use letter display
            const deleteSample = (sampleId) => { /* ... validation ... */ const sampleIndex = samples.findIndex(s => s.id === sampleId); const sample = samples[sampleIndex]; const rack = racks.find(r => r.id === sample.rackId); sample.isDeleted = true; sample.deletedAt = new Date().toISOString(); sample.updatedAt = sample.deletedAt; logHistory('sample_delete', `Sample "${sample.sampleUniqueId}" deleted from ${rack?.name || 'Unknown Rack'} at R${sample.row}C${getColumnLetter(sample.col)}.`, sampleId); selectedSampleId = null; sampleDetailsEl.classList.add('hidden'); renderRackGrid(); showMessage(`Sample "${sample.sampleUniqueId}" deleted.`); }; // Use letter in log
            const restoreSample = (sampleId) => { /* ... validation ... */ const sampleIndex = samples.findIndex(s => s.id === sampleId); const sample = samples[sampleIndex]; const rack = racks.find(r => r.id === sample.rackId); if (!rack) { showMessage(`Cannot restore: Original rack not found.`, 'error'); return; } if (isLocationOccupied(sample.rackId, sample.row, sample.col)) { showMessage(`Cannot restore: Location R${sample.row}C${getColumnLetter(sample.col)} in rack "${rack.name}" occupied.`, 'error'); return; } samples[sampleIndex].isDeleted = false; samples[sampleIndex].deletedAt = null; samples[sampleIndex].updatedAt = new Date().toISOString(); logHistory('sample_restore', `Sample "${sample.sampleUniqueId}" restored to ${rack.name} at R${sample.row}C${getColumnLetter(sample.col)}.`, sampleId); if (sample.rackId === selectedRackId) { renderRackGrid(); } renderHistoryLog(); showMessage(`Sample "${sample.sampleUniqueId}" restored.`); }; // Use letter in log & messages

            // --- Import/Export Functions (Unchanged) ---
            const exportDataToFile = () => { if (racks.length === 0 && samples.length === 0 && historyLog.length === 0) { showMessage("No data to export.", "error"); return; } const dataToExport = { racks: racks, samples: samples, historyLog: historyLog }; const dataStr = JSON.stringify(dataToExport, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const tempLink = document.createElement('a'); tempLink.href = url; tempLink.setAttribute('download', 'blood_sample_data_log.json'); tempLink.click(); URL.revokeObjectURL(url); showMessage("Data exported successfully (with history)."); };
            const importDataFromFile = (event) => { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (Array.isArray(importedData.racks) && Array.isArray(importedData.samples) && Array.isArray(importedData.historyLog)) { racks = importedData.racks; samples = importedData.samples; historyLog = importedData.historyLog; selectedRackId = null; selectedSampleId = null; sampleDetailsEl.classList.add('hidden'); refreshAllViews(); showMessage("Data imported successfully (with history)."); } else if (Array.isArray(importedData.racks) && Array.isArray(importedData.samples)) { racks = importedData.racks; samples = importedData.samples; historyLog = []; logHistory('system_info', 'Imported data from older format (no history log included).'); selectedRackId = null; selectedSampleId = null; sampleDetailsEl.classList.add('hidden'); refreshAllViews(); showMessage("Data imported successfully (older format, history reset)."); } else { showMessage("Invalid file format: Missing 'racks', 'samples', or 'historyLog' array.", "error"); } } catch (error) { showMessage(`Error parsing file: ${error.message}`, "error"); console.error("Import error:", error); } finally { event.target.value = null; } }; reader.onerror = (e) => { showMessage("Error reading file.", "error"); event.target.value = null; }; reader.readAsText(file); };

            // --- Modal Handling ---
            const openModal = (modal) => { modal.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden')); modal.classList.add('active'); };
            const closeModal = (modal) => { modal.classList.remove('active'); const form = modal.querySelector('form'); if (form) form.reset(); modal.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden')); };
            const openAddSampleModal = (rackId, prefillRow = null, prefillCol = null) => { const rack = racks.find(r => r.id === rackId); if (!rack) return; modalRackNameEl.textContent = escapeHtml(rack.name); sampleRackIdInput.value = rackId; sampleRowInput.value = prefillRow || ''; sampleColInput.value = prefillCol || ''; sampleColLetterPreview.textContent = prefillCol ? getColumnLetter(prefillCol) : ''; openModal(addSampleModal); }; // Show letter preview
            const openEditRackModal = (rackId) => { const rack = racks.find(r => r.id === rackId); if (!rack) { showMessage("Rack not found.", "error"); return; } editRackIdInput.value = rack.id; editRackNameInput.value = rack.name; editRackRowsInput.value = rack.rows; editRackColsInput.value = rack.cols; openModal(editRackModal); };
            const openEditSampleModal = (sampleId) => { const sample = samples.find(s => s.id === sampleId); if (!sample) { showMessage("Sample not found.", "error"); return; } const rack = racks.find(r => r.id === sample.rackId); editSampleIdInput.value = sample.id; editSampleUniqueIdInput.value = sample.sampleUniqueId; editSampleCommentInput.value = sample.comment || ''; editSampleLocationRack.textContent = escapeHtml(rack ? rack.name : 'Unknown'); editSampleLocationRow.textContent = sample.row; editSampleLocationColLetter.textContent = getColumnLetter(sample.col); openModal(editSampleModal); }; // Show letter

            // --- Event Listeners ---
            // Add listener for column input in Add Sample modal to update letter preview
            sampleColInput.addEventListener('input', (e) => {
                const colNum = parseInt(e.target.value, 10);
                sampleColLetterPreview.textContent = colNum > 0 ? getColumnLetter(colNum) : '';
            });
            // (Keep all other event listeners)
            addRackButton.addEventListener('click', () => openModal(addRackModal)); cancelAddRackButton.addEventListener('click', () => closeModal(addRackModal)); addRackForm.addEventListener('submit', (e) => { e.preventDefault(); addRack(addRackNameInput.value, document.getElementById('add-rack-rows').value, document.getElementById('add-rack-cols').value); });
            cancelEditRackButton.addEventListener('click', () => closeModal(editRackModal)); editRackForm.addEventListener('submit', (e) => { e.preventDefault(); updateRack(editRackIdInput.value, editRackNameInput.value, editRackRowsInput.value, editRackColsInput.value); });
            addSampleButton.addEventListener('click', () => { if(selectedRackId) openAddSampleModal(selectedRackId); }); cancelAddSampleButton.addEventListener('click', () => closeModal(addSampleModal)); addSampleForm.addEventListener('submit', (e) => { e.preventDefault(); addSample(sampleRackIdInput.value, sampleUniqueIdInput.value, sampleCommentInput.value, sampleRowInput.value, sampleColInput.value); });
            editSampleButton.addEventListener('click', () => { if (selectedSampleId) openEditSampleModal(selectedSampleId); }); cancelEditSampleButton.addEventListener('click', () => closeModal(editSampleModal)); editSampleForm.addEventListener('submit', (e) => { e.preventDefault(); updateSample(editSampleIdInput.value, editSampleUniqueIdInput.value, editSampleCommentInput.value); });
            deleteSampleButton.addEventListener('click', () => { if (selectedSampleId) { const sample = samples.find(s => s.id === selectedSampleId); if (confirm(`Delete sample ${sample?.sampleUniqueId || 'this sample'}?`)) { deleteSample(selectedSampleId); } } }); closeDetailsButton.addEventListener('click', () => { sampleDetailsEl.classList.add('hidden'); selectedSampleId = null; });
            tabMainButton.addEventListener('click', () => switchTab('main-content')); tabManageRacksButton.addEventListener('click', () => switchTab('manage-racks-content')); tabHistoryButton.addEventListener('click', () => switchTab('history-content'));
            exportDataButton.addEventListener('click', exportDataToFile); importDataButton.addEventListener('click', () => importFileInput.click()); importFileInput.addEventListener('change', importDataFromFile);
            window.addEventListener('click', (event) => { if (event.target === addRackModal) closeModal(addRackModal); if (event.target === addSampleModal) closeModal(addSampleModal); if (event.target === editRackModal) closeModal(editRackModal); if (event.target === editSampleModal) closeModal(editSampleModal); });

            // --- Initial Load ---
            refreshAllViews();
            lucide.createIcons();
        });
    </script>

</body>
</html>
