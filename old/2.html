<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Sample Tracker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif; /* Default Tailwind font */
        }
        /* Style for the grid cells */
        .grid-cell {
            border: 1px solid #d1d5db; /* gray-300 */
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            overflow: hidden; /* Prevent text overflow */
            text-overflow: ellipsis; /* Add ellipsis for long text */
            white-space: nowrap; /* Keep text on one line */
            padding: 0 2px; /* Add slight padding */
        }
        .grid-cell.empty:hover {
            background-color: #e0f2fe; /* sky-100 */
        }
        .grid-cell.occupied {
            background-color: #bfdbfe; /* blue-200 */
            font-weight: 500; /* medium */
            cursor: default; /* Change cursor for occupied cells */
        }
        .grid-cell.occupied:hover {
            background-color: #93c5fd; /* blue-300 */
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Dim background */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem; /* p-8 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            max-width: 500px;
            width: 90%;
        }
        .modal.active {
            display: flex; /* Show when active */
        }
        /* Simple Tab Styling */
        .tab-button.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h1 class="text-3xl font-bold text-gray-800">Blood Sample Tracker</h1>
            <div class="flex space-x-2">
                 <button id="import-data-button" title="Import Data from JSON File" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="upload" class="mr-2 h-4 w-4"></i> Import
                </button>
                <button id="export-data-button" title="Export Data to JSON File" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i data-lucide="download" class="mr-2 h-4 w-4"></i> Export
                </button>
                <input type="file" id="import-file-input" accept=".json" class="hidden">
            </div>
        </div>


        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-main" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="main-content">
                    Racks & Samples
                </button>
                <button id="tab-history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="history-content">
                    History
                </button>
            </nav>
        </div>

        <div id="main-content" class="tab-pane active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <div class="md:col-span-1 space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-700">Racks</h2>
                        <button id="add-rack-button" class="w-full mb-4 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i data-lucide="plus-circle" class="mr-2 h-5 w-5"></i> Create New Rack
                        </button>
                        <div id="rack-list" class="space-y-2 max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                            <p class="text-gray-500 italic">No racks created yet. Import data or create a new rack.</p>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 space-y-6">
                    <div id="selected-rack-view" class="bg-gray-50 p-4 rounded-md border min-h-[200px]">
                        <h2 id="rack-title" class="text-xl font-semibold mb-3 text-gray-700">Select a Rack</h2>
                        <div id="rack-grid" class="grid gap-1 mb-4" style="grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));">
                            <p class="text-gray-500 italic col-span-full">Select a rack from the list to view its grid.</p>
                        </div>
                         <button id="add-sample-button" class="hidden mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i data-lucide="flask-conical" class="mr-2 h-5 w-5"></i> Add Sample to this Rack
                        </button>
                    </div>

                    <div id="sample-details" class="bg-blue-50 p-4 rounded-md border border-blue-200 hidden">
                        <h3 class="text-lg font-semibold mb-2 text-blue-800">Sample Details</h3>
                        <p><strong>ID:</strong> <span id="detail-sample-id"></span></p>
                        <p><strong>Location:</strong> Rack <span id="detail-rack-name"></span>, Row <span id="detail-row"></span>, Col <span id="detail-col"></span></p>
                        <p><strong>Comment:</strong> <span id="detail-comment"></span></p>
                        <p><strong>Created:</strong> <span id="detail-created"></span></p>
                        <p><strong>Modified:</strong> <span id="detail-modified"></span></p>
                        <button id="delete-sample-button" class="mt-3 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i data-lucide="trash-2" class="mr-1 h-4 w-4"></i> Delete Sample
                        </button>
                         <button id="close-details-button" class="mt-3 ml-2 inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-content" class="tab-pane hidden">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Deleted Samples History</h2>
             <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sample ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Location</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Deleted</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        <tr id="no-history-row">
                            <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic text-center">No deleted samples found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="add-rack-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Create New Rack</h3>
            <form id="add-rack-form">
                <div class="space-y-4">
                    <div>
                        <label for="rack-name" class="block text-sm font-medium text-gray-700">Rack Name</label>
                        <input type="text" name="rack-name" id="rack-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Freezer A - Shelf 1">
                    </div>
                    <div>
                        <label for="rack-rows" class="block text-sm font-medium text-gray-700">Number of Rows</label>
                        <input type="number" name="rack-rows" id="rack-rows" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="rack-cols" class="block text-sm font-medium text-gray-700">Number of Columns</label>
                        <input type="number" name="rack-cols" id="rack-cols" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 8">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-rack" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Cancel</button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Create Rack</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-sample-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New Sample to <span id="modal-rack-name" class="font-bold"></span></h3>
            <form id="add-sample-form">
                 <input type="hidden" id="sample-rack-id">
                 <div class="space-y-4">
                    <div>
                        <label for="sample-unique-id" class="block text-sm font-medium text-gray-700">Unique Sample ID</label>
                        <input type="text" name="sample-unique-id" id="sample-unique-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., BS2025-001">
                        <p id="sample-id-error" class="text-red-500 text-xs mt-1 hidden">This Sample ID is already in use.</p>
                    </div>
                     <div>
                        <label for="sample-row" class="block text-sm font-medium text-gray-700">Row</label>
                        <input type="number" name="sample-row" id="sample-row" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Enter row number">
                    </div>
                     <div>
                        <label for="sample-col" class="block text-sm font-medium text-gray-700">Column</label>
                        <input type="number" name="sample-col" id="sample-col" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Enter column number">
                    </div>
                     <p id="location-error" class="text-red-500 text-xs mt-1 hidden">Invalid or occupied location.</p>
                     <div>
                        <label for="sample-comment" class="block text-sm font-medium text-gray-700">Comment (Optional)</label>
                        <textarea name="sample-comment" id="sample-comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Add any relevant notes..."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-sample" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Cancel</button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Add Sample</button>
                </div>
            </form>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 z-50 hidden rounded-md p-4 shadow-lg" role="alert">
        <p id="message-text"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const rackListEl = document.getElementById('rack-list');
            const addRackButton = document.getElementById('add-rack-button');
            const addRackModal = document.getElementById('add-rack-modal');
            const addRackForm = document.getElementById('add-rack-form');
            const cancelAddRackButton = document.getElementById('cancel-add-rack');

            const selectedRackViewEl = document.getElementById('selected-rack-view');
            const rackTitleEl = document.getElementById('rack-title');
            const rackGridEl = document.getElementById('rack-grid');
            const addSampleButton = document.getElementById('add-sample-button');

            const addSampleModal = document.getElementById('add-sample-modal');
            const addSampleForm = document.getElementById('add-sample-form');
            const cancelAddSampleButton = document.getElementById('cancel-add-sample');
            const modalRackNameEl = document.getElementById('modal-rack-name');
            const sampleRackIdInput = document.getElementById('sample-rack-id');
            const sampleUniqueIdInput = document.getElementById('sample-unique-id');
            const sampleRowInput = document.getElementById('sample-row');
            const sampleColInput = document.getElementById('sample-col');
            const sampleCommentInput = document.getElementById('sample-comment');
            const sampleIdErrorEl = document.getElementById('sample-id-error');
            const locationErrorEl = document.getElementById('location-error');

            const sampleDetailsEl = document.getElementById('sample-details');
            const detailSampleIdEl = document.getElementById('detail-sample-id');
            const detailRackNameEl = document.getElementById('detail-rack-name');
            const detailRowEl = document.getElementById('detail-row');
            const detailColEl = document.getElementById('detail-col');
            const detailCommentEl = document.getElementById('detail-comment');
            const detailCreatedEl = document.getElementById('detail-created');
            const detailModifiedEl = document.getElementById('detail-modified');
            const deleteSampleButton = document.getElementById('delete-sample-button');
            const closeDetailsButton = document.getElementById('close-details-button');

            const mainContentEl = document.getElementById('main-content');
            const historyContentEl = document.getElementById('history-content');
            const historyTableBodyEl = document.getElementById('history-table-body');
            const noHistoryRowEl = document.getElementById('no-history-row');
            const tabMainButton = document.getElementById('tab-main');
            const tabHistoryButton = document.getElementById('tab-history');

            const messageBoxEl = document.getElementById('message-box');
            const messageTextEl = document.getElementById('message-text');

            // Import/Export Elements
            const importDataButton = document.getElementById('import-data-button');
            const exportDataButton = document.getElementById('export-data-button');
            const importFileInput = document.getElementById('import-file-input');


            // --- State ---
            // Data is now held only in memory, loaded/saved via file import/export
            let racks = [];
            let samples = [];
            let selectedRackId = null;
            let selectedSampleId = null; // Internal DB ID of the sample being detailed/deleted

            // --- Utility Functions ---
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleString() : 'N/A';

            const showMessage = (text, type = 'success') => {
                messageTextEl.textContent = text;
                messageBoxEl.className = `fixed bottom-4 right-4 z-50 rounded-md p-4 shadow-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                messageBoxEl.classList.remove('hidden');
                setTimeout(() => {
                    messageBoxEl.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            };

            // --- REMOVED localStorage saveData() function ---
            // const saveData = () => {
            //     localStorage.setItem('racks', JSON.stringify(racks));
            //     localStorage.setItem('samples', JSON.stringify(samples));
            // };

            // --- Validation Functions ---
            const isSampleIdUnique = (uniqueId, sampleIdToExclude = null) => {
                // Check against current in-memory data
                return !samples.some(s => s.sampleUniqueId === uniqueId && !s.isDeleted && s.id !== sampleIdToExclude);
            };

            const isLocationValid = (rack, row, col) => {
                if (!rack || typeof rack.rows !== 'number' || typeof rack.cols !== 'number') return false; // Basic check
                return row >= 1 && row <= rack.rows && col >= 1 && col <= rack.cols;
            };

            const isLocationOccupied = (rackId, row, col, sampleIdToExclude = null) => {
                 // Check against current in-memory data
                 return samples.some(s =>
                    s.rackId === rackId &&
                    s.row === row &&
                    s.col === col &&
                    !s.isDeleted &&
                    s.id !== sampleIdToExclude
                );
            };

            // --- Rendering Functions ---
            const renderRackList = () => {
                rackListEl.innerHTML = ''; // Clear existing list
                if (racks.length === 0) {
                    rackListEl.innerHTML = '<p class="text-gray-500 italic">No racks created yet. Import data or create a new rack.</p>';
                    return;
                }
                racks.forEach(rack => {
                    const rackDiv = document.createElement('div');
                    rackDiv.className = `p-3 border rounded-md cursor-pointer hover:bg-gray-200 ${rack.id === selectedRackId ? 'bg-blue-100 border-blue-300' : 'bg-white'}`;
                    rackDiv.dataset.rackId = rack.id;
                    rackDiv.innerHTML = `
                        <p class="font-medium text-gray-800">${rack.name}</p>
                        <p class="text-sm text-gray-600">${rack.rows} x ${rack.cols}</p>
                    `;
                    rackDiv.addEventListener('click', () => selectRack(rack.id));
                    rackListEl.appendChild(rackDiv);
                });
            };

            const renderRackGrid = () => {
                rackGridEl.innerHTML = ''; // Clear existing grid
                sampleDetailsEl.classList.add('hidden'); // Hide details pane when grid renders
                addSampleButton.classList.add('hidden'); // Hide add sample button initially

                if (!selectedRackId) {
                    rackTitleEl.textContent = 'Select a Rack';
                     rackGridEl.innerHTML = '<p class="text-gray-500 italic col-span-full">Select a rack from the list to view its grid.</p>';
                    return;
                }

                const rack = racks.find(r => r.id === selectedRackId);
                if (!rack) {
                     rackTitleEl.textContent = 'Rack Not Found';
                     rackGridEl.innerHTML = '<p class="text-red-500 italic col-span-full">Error: Could not find the selected rack.</p>';
                     selectedRackId = null; // Deselect if rack is gone
                    return;
                }

                rackTitleEl.textContent = `Rack: ${rack.name} (${rack.rows}x${rack.cols})`;
                addSampleButton.classList.remove('hidden'); // Show add sample button

                rackGridEl.style.gridTemplateColumns = `repeat(${rack.cols}, minmax(50px, 1fr))`;
                rackGridEl.style.gridTemplateRows = `repeat(${rack.rows}, minmax(50px, 1fr))`;

                const rackSamples = samples.filter(s => s.rackId === selectedRackId && !s.isDeleted);

                for (let r = 1; r <= rack.rows; r++) {
                    for (let c = 1; c <= rack.cols; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const sampleInCell = rackSamples.find(s => s.row === r && s.col === c);

                        if (sampleInCell) {
                            cell.classList.add('occupied');
                            cell.textContent = sampleInCell.sampleUniqueId;
                            cell.title = `Sample: ${sampleInCell.sampleUniqueId}\nComment: ${sampleInCell.comment || 'None'}`;
                            // Make occupied cell clickable to show details
                            cell.style.cursor = 'pointer'; // Explicitly set cursor
                            cell.addEventListener('click', () => showSampleDetails(sampleInCell.id));
                        } else {
                            cell.classList.add('empty');
                            cell.title = `Empty: R${r}C${c}`;
                            // Click empty cell to pre-fill add sample form
                            cell.addEventListener('click', () => {
                                openAddSampleModal(selectedRackId, r, c);
                            });
                        }
                        rackGridEl.appendChild(cell);
                    }
                }
            };

             const renderHistory = () => {
                historyTableBodyEl.innerHTML = ''; // Clear existing history
                const deletedSamples = samples.filter(s => s.isDeleted).sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt));

                if (deletedSamples.length === 0) {
                    // Ensure the "No history" row exists before trying to append/show it
                    if (noHistoryRowEl) {
                         historyTableBodyEl.appendChild(noHistoryRowEl);
                         noHistoryRowEl.classList.remove('hidden');
                    } else {
                        // Fallback if somehow the row was removed from the DOM
                         historyTableBodyEl.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic text-center">No deleted samples found.</td></tr>';
                    }
                    return;
                }

                 if (noHistoryRowEl) noHistoryRowEl.classList.add('hidden'); // Hide the "No history" row if it exists

                deletedSamples.forEach(sample => {
                    const rack = racks.find(r => r.id === sample.rackId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sample.sampleUniqueId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rack ? rack.name : 'Unknown Rack'} (R${sample.row}C${sample.col})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${sample.comment || ''}">${sample.comment || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(sample.deletedAt)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-sample-id="${sample.id}" class="restore-button text-indigo-600 hover:text-indigo-900">Restore</button>
                        </td>
                    `;
                    historyTableBodyEl.appendChild(row);
                });

                // Add event listeners to new restore buttons
                document.querySelectorAll('.restore-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const sampleIdToRestore = e.target.dataset.sampleId;
                        restoreSample(sampleIdToRestore);
                    });
                });
            };

            // --- Refresh All Views ---
            const refreshAllViews = () => {
                 renderRackList();
                 renderRackGrid(); // Will render empty state if selectedRackId is no longer valid or null
                 renderHistory();
            }

            // --- Action Functions ---
            const addRack = (name, rows, cols) => {
                if (!name || !rows || !cols || rows < 1 || cols < 1) {
                    showMessage('Invalid rack details provided.', 'error');
                    return;
                }
                 // Check if rack name already exists
                if (racks.some(r => r.name.toLowerCase() === name.trim().toLowerCase())) {
                    showMessage(`Rack name "${name.trim()}" already exists.`, 'error');
                    return;
                }

                const newRack = {
                    id: generateId(),
                    name: name.trim(),
                    rows: parseInt(rows, 10),
                    cols: parseInt(cols, 10),
                    createdAt: new Date().toISOString()
                };
                racks.push(newRack);
                // saveData(); // Removed localStorage saving
                renderRackList();
                closeModal(addRackModal);
                showMessage(`Rack "${newRack.name}" created successfully.`);
                selectRack(newRack.id); // Select the newly created rack
            };

            const selectRack = (rackId) => {
                selectedRackId = rackId;
                selectedSampleId = null; // Clear selected sample when rack changes
                renderRackList(); // Re-render list to highlight selection
                renderRackGrid(); // Render the grid for the selected rack
            };

            const addSample = (rackId, uniqueId, comment, row, col) => {
                 const rack = racks.find(r => r.id === rackId);
                 if (!rack) {
                    showMessage('Selected rack not found.', 'error');
                    return false; // Indicate failure
                 }

                 row = parseInt(row, 10);
                 col = parseInt(col, 10);
                 uniqueId = uniqueId.trim();

                 // 1. Check Unique ID
                 if (!isSampleIdUnique(uniqueId)) {
                    sampleIdErrorEl.textContent = `Sample ID "${uniqueId}" is already in use by an active sample.`;
                    sampleIdErrorEl.classList.remove('hidden');
                    showMessage('Sample ID validation failed.', 'error');
                    return false;
                 } else {
                    sampleIdErrorEl.classList.add('hidden');
                 }

                 // 2. Check Location Validity (Bounds) & Occupancy
                 let locationValid = true;
                 locationErrorEl.classList.add('hidden'); // Reset error message

                 if (!isLocationValid(rack, row, col)) {
                     locationErrorEl.textContent = `Location R${row}C${col} is outside the rack bounds (Rows: 1-${rack.rows}, Cols: 1-${rack.cols}).`;
                     locationValid = false;
                 } else if (isLocationOccupied(rackId, row, col)) {
                     locationErrorEl.textContent = `Location R${row}C${col} is already occupied.`;
                     locationValid = false;
                 }

                 if (!locationValid) {
                    locationErrorEl.classList.remove('hidden');
                    showMessage('Location validation failed.', 'error');
                    return false;
                 }

                 // All checks passed, create the sample
                 const now = new Date().toISOString();
                 const newSample = {
                    id: generateId(),
                    sampleUniqueId: uniqueId,
                    comment: comment.trim() || null,
                    rackId: rackId,
                    row: row,
                    col: col,
                    createdAt: now,
                    updatedAt: now,
                    isDeleted: false,
                    deletedAt: null
                 };

                 samples.push(newSample);
                 // saveData(); // Removed localStorage saving
                 renderRackGrid(); // Update grid view
                 closeModal(addSampleModal);
                 showMessage(`Sample "${uniqueId}" added successfully to R${row}C${col}.`);
                 return true; // Indicate success
            };

            const showSampleDetails = (sampleId) => {
                const sample = samples.find(s => s.id === sampleId && !s.isDeleted); // Ensure sample exists and is not deleted
                if (!sample) {
                    sampleDetailsEl.classList.add('hidden'); // Hide if not found or deleted
                    selectedSampleId = null;
                    return;
                }

                const rack = racks.find(r => r.id === sample.rackId);
                selectedSampleId = sample.id; // Store the ID for potential deletion

                detailSampleIdEl.textContent = sample.sampleUniqueId;
                detailRackNameEl.textContent = rack ? rack.name : 'Unknown';
                detailRowEl.textContent = sample.row;
                detailColEl.textContent = sample.col;
                detailCommentEl.textContent = sample.comment || 'None';
                detailCreatedEl.textContent = formatDate(sample.createdAt);
                detailModifiedEl.textContent = formatDate(sample.updatedAt);

                sampleDetailsEl.classList.remove('hidden');
            };

            const deleteSample = (sampleId) => {
                const sampleIndex = samples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1 || samples[sampleIndex].isDeleted) return; // Don't delete already deleted

                samples[sampleIndex].isDeleted = true;
                samples[sampleIndex].deletedAt = new Date().toISOString();
                samples[sampleIndex].updatedAt = samples[sampleIndex].deletedAt; // Update modified time too

                // saveData(); // Removed localStorage saving
                selectedSampleId = null; // Clear selection
                sampleDetailsEl.classList.add('hidden'); // Hide details pane
                renderRackGrid(); // Update grid
                renderHistory(); // Update history view
                showMessage(`Sample "${samples[sampleIndex].sampleUniqueId}" deleted.`);
            };

            const restoreSample = (sampleId) => {
                const sampleIndex = samples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1 || !samples[sampleIndex].isDeleted) {
                    showMessage('Sample not found or not deleted.', 'error');
                    return;
                }

                const sample = samples[sampleIndex];
                const rack = racks.find(r => r.id === sample.rackId);

                // Check if the original location is now occupied by an ACTIVE sample
                if (isLocationOccupied(sample.rackId, sample.row, sample.col)) {
                     showMessage(`Cannot restore: Location R${sample.row}C${sample.col} in rack "${rack?.name || 'Unknown'}" is now occupied.`, 'error');
                     return;
                }

                // Restore the sample
                samples[sampleIndex].isDeleted = false;
                samples[sampleIndex].deletedAt = null;
                samples[sampleIndex].updatedAt = new Date().toISOString();

                // saveData(); // Removed localStorage saving
                renderHistory(); // Update history list
                // If the restored sample belongs to the currently selected rack, refresh its grid
                if (sample.rackId === selectedRackId) {
                    renderRackGrid();
                }
                showMessage(`Sample "${sample.sampleUniqueId}" restored successfully.`);
            };

            // --- Import/Export Functions ---
            const exportDataToFile = () => {
                if (racks.length === 0 && samples.length === 0) {
                    showMessage("No data to export.", "error");
                    return;
                }
                const dataToExport = {
                    racks: racks,
                    samples: samples
                };
                const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const tempLink = document.createElement('a');
                tempLink.href = url;
                tempLink.setAttribute('download', 'blood_sample_data.json');
                tempLink.click(); // Trigger download

                URL.revokeObjectURL(url); // Clean up temporary URL
                showMessage("Data exported successfully.");
            };

            const importDataFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return; // No file selected
                }

                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Basic validation: Check if 'racks' and 'samples' arrays exist
                        if (Array.isArray(importedData.racks) && Array.isArray(importedData.samples)) {
                            // Replace current data
                            racks = importedData.racks;
                            samples = importedData.samples;

                            // Reset selections and refresh UI
                            selectedRackId = null;
                            selectedSampleId = null;
                            refreshAllViews(); // Update all parts of the UI

                            showMessage("Data imported successfully.");
                        } else {
                            showMessage("Invalid file format: Missing 'racks' or 'samples' array.", "error");
                        }
                    } catch (error) {
                        showMessage(`Error parsing file: ${error.message}`, "error");
                        console.error("Import error:", error);
                    } finally {
                         // Reset file input to allow importing the same file again if needed
                         event.target.value = null;
                    }
                };

                reader.onerror = (e) => {
                    showMessage("Error reading file.", "error");
                     event.target.value = null; // Reset file input
                };

                reader.readAsText(file); // Read the file content
            };


            // --- Modal Handling ---
            const openModal = (modal) => {
                modal.classList.add('active');
            };
            const closeModal = (modal) => {
                modal.classList.remove('active');
                // Reset forms within the modal if applicable
                const form = modal.querySelector('form');
                if (form) form.reset();
                 // Clear specific error messages
                sampleIdErrorEl?.classList.add('hidden');
                locationErrorEl?.classList.add('hidden');
            };

            const openAddSampleModal = (rackId, prefillRow = null, prefillCol = null) => {
                const rack = racks.find(r => r.id === rackId);
                if (!rack) return;

                modalRackNameEl.textContent = rack.name;
                sampleRackIdInput.value = rackId;
                // Pre-fill location if provided (e.g., clicking an empty cell)
                sampleRowInput.value = prefillRow || '';
                sampleColInput.value = prefillCol || '';
                openModal(addSampleModal);
            };

            // --- Tab Navigation ---
             const switchTab = (targetId) => {
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');

                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                document.querySelector(`.tab-button[data-target='${targetId}']`).classList.add('active');

                // Refresh history when switching to it (important now data isn't auto-saved)
                if (targetId === 'history-content') {
                    renderHistory();
                } else if (targetId === 'main-content') {
                    // Optionally refresh main view too if needed, e.g., after an import
                    renderRackList();
                    renderRackGrid();
                }
            };


            // --- Event Listeners ---
            addRackButton.addEventListener('click', () => openModal(addRackModal));
            cancelAddRackButton.addEventListener('click', () => closeModal(addRackModal));
            addRackForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('rack-name').value;
                const rows = document.getElementById('rack-rows').value;
                const cols = document.getElementById('rack-cols').value;
                addRack(name, rows, cols);
            });

            addSampleButton.addEventListener('click', () => {
                if(selectedRackId) openAddSampleModal(selectedRackId);
            });
            cancelAddSampleButton.addEventListener('click', () => closeModal(addSampleModal));
            addSampleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const rackId = sampleRackIdInput.value;
                const uniqueId = sampleUniqueIdInput.value;
                const row = sampleRowInput.value;
                const col = sampleColInput.value;
                const comment = sampleCommentInput.value;
                addSample(rackId, uniqueId, comment, row, col);
                 // Keep modal open on validation failure handled within addSample
            });

            deleteSampleButton.addEventListener('click', () => {
                if (selectedSampleId) {
                    // Find the sample name for the confirmation message
                     const sampleToDelete = samples.find(s => s.id === selectedSampleId);
                     const sampleNameToConfirm = sampleToDelete ? sampleToDelete.sampleUniqueId : 'this sample';
                    if (confirm(`Are you sure you want to delete sample ${sampleNameToConfirm}? This action cannot be undone without re-importing previous data.`)) {
                        deleteSample(selectedSampleId);
                    }
                }
            });
             closeDetailsButton.addEventListener('click', () => {
                sampleDetailsEl.classList.add('hidden');
                selectedSampleId = null;
            });

            // Tab switching listeners
            tabMainButton.addEventListener('click', () => switchTab('main-content'));
            tabHistoryButton.addEventListener('click', () => switchTab('history-content'));

            // Import/Export Listeners
            exportDataButton.addEventListener('click', exportDataToFile);
            importDataButton.addEventListener('click', () => importFileInput.click()); // Trigger hidden file input
            importFileInput.addEventListener('change', importDataFromFile);


            // Close modals if clicking outside the content
            window.addEventListener('click', (event) => {
                if (event.target === addRackModal) closeModal(addRackModal);
                if (event.target === addSampleModal) closeModal(addSampleModal);
            });

            // --- Initial Load ---
            // No longer loading from localStorage
            refreshAllViews(); // Render initial empty state (or state after potential import)
            lucide.createIcons(); // Initialize Lucide icons
        });
    </script>

</body>
</html>
